<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>FFA Accounting System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Navigation CSS -->
    <link rel="stylesheet" href="navigation.css">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#1a73e8">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* ============================================
            CSS VARIABLES & RESET
            ============================================ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      :root {
        /* Colors */
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-light: #3b82f6;
        --success: #10b981;
        --success-dark: #059669;
        --warning: #f59e0b;
        --warning-dark: #d97706;
        --danger: #ef4444;
        --danger-dark: #dc2626;
        --info: #3b82f6;
        --secondary: #64748b;

        /* Neutrals */
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-400: #94a3b8;
        --gray-500: #64748b;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --gray-900: #0f172a;

        /* Background */
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f1f5f9;

        /* Text */
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-tertiary: #94a3b8;

        /* Border */
        --border-color: #e2e8f0;

        /* Shadow */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

        /* Spacing (Mobile-first) */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;

        /* Border Radius */
        --radius-sm: 0.375rem;
        --radius: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-full: 9999px;

        /* Transitions */
        --transition: 200ms ease;

        /* Z-index */
        --z-modal: 2000;
        --z-toast: 3000;
        --z-sticky: 1100;

        /* Mobile-first Sidebar */
        --sidebar-width: 100%;
        --header-height: 56px;
      }

      /* Desktop adjustments */
      @media (min-width: 768px) {
        :root {
          --sidebar-width: 260px;
          --header-height: 64px;
        }
      }

      /* ============================================
            BASE STYLES (Mobile-optimized)
            ============================================ */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: var(--text-primary);
        background: var(--bg-primary);
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
        touch-action: manipulation;
      }

      /* ============================================
            UTILITY CLASSES
            ============================================ */
      .hidden {
        display: none !important;
      }
      .flex {
        display: flex;
      }
      .flex-col {
        flex-direction: column;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .justify-center {
        justify-content: center;
      }
      .gap-2 {
        gap: var(--space-2);
      }
      .gap-3 {
        gap: var(--space-3);
      }
      .gap-4 {
        gap: var(--space-4);
      }
      .text-center {
        text-align: center;
      }
      .text-right {
        text-align: right;
      }
      .w-full {
        width: 100%;
      }

      /* ============================================
            TYPOGRAPHY (Mobile-optimized)
            ============================================ */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-weight: 600;
        line-height: 1.2;
        color: var(--text-primary);
      }

      h1 {
        font-size: 1.5rem;
      }
      h2 {
        font-size: 1.25rem;
      }
      h3 {
        font-size: 1.125rem;
      }
      h4,
      h5,
      h6 {
        font-size: 1rem;
      }

      @media (min-width: 768px) {
        h1 {
          font-size: 2rem;
        }
        h2 {
          font-size: 1.5rem;
        }
        h3 {
          font-size: 1.25rem;
        }
      }

      p {
        margin-bottom: var(--space-4);
      }
      small {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      /* ============================================
            BUTTONS (Touch-friendly 44px min)
            ============================================ */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: 0.75rem 1.25rem;
        font-size: 0.9375rem;
        font-weight: 500;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        white-space: nowrap;
        user-select: none;
        min-height: 44px;
        -webkit-tap-highlight-color: transparent;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-warning {
        background: var(--warning);
        color: white;
      }
      .btn-danger {
        background: var(--danger);
        color: white;
      }
      .btn-secondary {
        background: var(--gray-200);
        color: var(--text-primary);
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark);
      }
      .btn-success:hover:not(:disabled) {
        background: var(--success-dark);
      }
      .btn-warning:hover:not(:disabled) {
        background: var(--warning-dark);
      }
      .btn-danger:hover:not(:disabled) {
        background: var(--danger-dark);
      }
      .btn-secondary:hover:not(:disabled) {
        background: var(--gray-300);
      }

      .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        min-height: 38px;
      }

      .btn-lg {
        padding: 1rem 1.5rem;
        font-size: 1rem;
      }

      .btn-icon {
        width: 44px;
        height: 44px;
        padding: 0;
        border-radius: var(--radius-full);
      }

      /* ============================================
            FORM ELEMENTS (Mobile-optimized)
            ============================================ */
      .form-group {
        margin-bottom: var(--space-4);
      }

      .form-label {
        display: block;
        margin-bottom: var(--space-2);
        font-size: 0.9375rem;
        font-weight: 500;
      }

      .form-label.required::after {
        content: "*";
        color: var(--danger);
        margin-left: var(--space-1);
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem; /* Prevent iOS zoom */
        line-height: 1.5;
        color: var(--text-primary);
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        transition: var(--transition);
        min-height: 44px;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-input::placeholder {
        color: var(--text-tertiary);
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }

      @media (min-width: 768px) {
        .form-row {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
      }

      /* ============================================
            CARDS
            ============================================ */
      .card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }

      .card-header {
        padding: var(--space-4);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
      }

      .card-body {
        padding: var(--space-4);
      }

      @media (min-width: 768px) {
        .card-header,
        .card-body {
          padding: var(--space-6);
        }
      }

      /* ============================================
            BADGES
            ============================================ */
      .badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: var(--radius-full);
        white-space: nowrap;
      }

      .badge-primary {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
      }
      .badge-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
      }
      .badge-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
      }
      .badge-danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }
      .badge-secondary {
        background: var(--gray-100);
        color: var(--gray-700);
      }

      /* ============================================
            TABLES (Mobile-responsive)
            ============================================ */
      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      .table th,
      .table td {
        padding: var(--space-3);
        font-size: 0.875rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      .table th {
        background: var(--bg-tertiary);
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.025em;
        font-size: 0.75rem;
      }

      .table tbody tr {
        transition: background var(--transition);
      }

      .table tbody tr:hover {
        background: var(--bg-tertiary);
      }

      /* ============================================
            LOADING SPINNER
            ============================================ */
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      .spinner-primary {
        border-color: rgba(37, 99, 235, 0.2);
        border-top-color: var(--primary);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ============================================
            TOAST NOTIFICATIONS (Mobile-optimized)
            ============================================ */
      .toast-container {
        position: fixed;
        bottom: var(--space-4);
        left: var(--space-4);
        right: var(--space-4);
        z-index: var(--z-toast);
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      @media (min-width: 768px) {
        .toast-container {
          left: auto;
          right: var(--space-6);
          max-width: 400px;
        }
      }

      .toast {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        animation: slideInMobile 0.3s ease-out;
      }

      @keyframes slideInMobile {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @media (min-width: 768px) {
        .toast {
          animation: slideInDesktop 0.3s ease-out;
        }

        @keyframes slideInDesktop {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
      }

      .toast-icon {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
      }

      .toast-success .toast-icon {
        color: var(--success);
      }
      .toast-error .toast-icon {
        color: var(--danger);
      }
      .toast-warning .toast-icon {
        color: var(--warning);
      }
      .toast-info .toast-icon {
        color: var(--info);
      }

      .toast-content {
        flex: 1;
      }
      .toast-message {
        font-size: 0.875rem;
      }

      .toast-close {
        flex-shrink: 0;
        background: none;
        border: none;
        color: var(--text-tertiary);
        cursor: pointer;
        padding: 0;
        min-width: 24px;
        min-height: 24px;
      }

      /* ============================================
            MODAL (Mobile-optimized)
            ============================================ */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: var(--z-modal);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        animation: fadeIn 0.2s;
      }

      @media (min-width: 768px) {
        .modal-overlay {
          align-items: center;
          padding: var(--space-4);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal {
        background: var(--bg-secondary);
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUpModal 0.3s ease-out;
      }

      @keyframes slideUpModal {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      @media (min-width: 768px) {
        .modal {
          border-radius: var(--radius-xl);
          max-width: 600px;
        }
      }

      .modal-header {
        padding: var(--space-4);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-tertiary);
        cursor: pointer;
        padding: 0;
        min-width: 32px;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius);
      }

      .modal-body {
        padding: var(--space-4);
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: var(--space-4);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: var(--space-3);
        flex-direction: column;
      }

      @media (min-width: 768px) {
        .modal-header,
        .modal-body,
        .modal-footer {
          padding: var(--space-6);
        }

        .modal-footer {
          flex-direction: row;
          justify-content: flex-end;
        }
      }

      /* ============================================
            LOGIN PAGE (Mobile-optimized)
            ============================================ */
      .login-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        padding: var(--space-4);
      }

      .login-card {
        width: 100%;
        max-width: 420px;
        padding: var(--space-6);
      }

      .login-header {
        text-align: center;
        margin-bottom: var(--space-6);
      }

      .login-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--primary);
        color: white;
        border-radius: var(--radius-xl);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
      }

      @media (min-width: 768px) {
        .login-card {
          padding: var(--space-8);
        }

        .login-icon {
          width: 80px;
          height: 80px;
          font-size: 2.5rem;
        }
      }

      /* ============================================
            DASHBOARD LAYOUT (Mobile-first)
            ============================================ */
      .dashboard-layout {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      @media (min-width: 768px) {
        .dashboard-layout {
          flex-direction: row;
        }
      }

      /* Sidebar - Bottom sheet on mobile */
      .sidebar {
        width: 100%;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: var(--z-sticky);
        transform: translateY(100%);
        transition: transform 0.3s ease;
        max-height: 80vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .sidebar.show {
        transform: translateY(0);
      }

      @media (min-width: 768px) {
        .sidebar {
          width: var(--sidebar-width);
          height: 100vh;
          position: fixed;
          top: 0;
          left: 0;
          bottom: auto;
          border-right: 1px solid var(--border-color);
          border-top: none;
          transform: translateX(0);
          max-height: none;
        }
      }

      .sidebar-header {
        padding: var(--space-4);
        border-bottom: 1px solid var(--border-color);
      }

      .sidebar-logo {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--primary);
      }

      .sidebar-nav {
        padding: var(--space-3) 0;
      }

      .nav-item {
        margin: var(--space-1) var(--space-3);
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: var(--radius);
        transition: var(--transition);
        font-weight: 500;
        min-height: 44px;
      }

      .nav-link:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .nav-link.active {
        background: var(--primary);
        color: white;
      }

      .nav-link i {
        width: 20px;
        text-align: center;
      }

      .sidebar-footer {
        padding: var(--space-4);
        border-top: 1px solid var(--border-color);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding-bottom: 60px; /* Space for mobile nav trigger */
      }

      @media (min-width: 768px) {
        .main-content {
          margin-left: var(--sidebar-width);
          padding-bottom: 0;
        }
      }

      .header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: var(--space-3) var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        height: var(--header-height);
        position: sticky;
        top: 0;
        z-index: calc(var(--z-sticky) - 1);
      }

      .header-title {
        flex: 1;
        font-size: 1.125rem;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      @media (min-width: 768px) {
        .header {
          padding: var(--space-4) var(--space-6);
        }

        .header-title {
          font-size: 1.5rem;
        }
      }

      .mobile-menu-toggle {
        display: flex;
      }

      @media (min-width: 768px) {
        .mobile-menu-toggle {
          display: none;
        }
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 0.875rem;
      }

      .user-info i {
        font-size: 1.5rem;
      }

      .user-info span:not(.badge) {
        display: none;
      }

      @media (min-width: 768px) {
        .user-info span:not(.badge) {
          display: inline;
        }
      }

      .content {
        padding: var(--space-4);
        background: var(--bg-primary);
      }

      @media (min-width: 768px) {
        .content {
          padding: var(--space-6);
        }
      }

      /* ============================================
            DASHBOARD COMPONENTS (Mobile-optimized)
            ============================================ */
      .section-header {
        margin-bottom: var(--space-4);
        padding-bottom: var(--space-3);
        border-bottom: 2px solid var(--border-color);
      }

      .section-header h2 {
        font-size: 1.25rem;
      }

      @media (min-width: 768px) {
        .section-header {
          margin-bottom: var(--space-6);
        }

        .section-header h2 {
          font-size: 1.5rem;
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
      }

      @media (min-width: 640px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (min-width: 1024px) {
        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: var(--space-6);
          margin-bottom: var(--space-8);
        }
      }

      .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
      }

      @media (min-width: 768px) {
        .stat-card {
          padding: var(--space-6);
        }

        .stat-card:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-md);
        }
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-3);
        font-size: 1.25rem;
      }

      @media (min-width: 768px) {
        .stat-icon {
          width: 48px;
          height: 48px;
          font-size: 1.5rem;
          margin-bottom: var(--space-4);
        }
      }

      .stat-icon.stat-primary {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
      }

      .stat-icon.stat-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
      }

      .stat-icon.stat-info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
      }

      .stat-icon.stat-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
      }

      .stat-icon.stat-danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin: var(--space-2) 0;
      }

      @media (min-width: 768px) {
        .stat-value {
          font-size: 1.875rem;
        }
      }

      .stat-value.stat-primary {
        color: var(--primary);
      }
      .stat-value.stat-success {
        color: var(--success);
      }
      .stat-value.stat-danger {
        color: var(--danger);
      }
      .stat-value.stat-secondary {
        color: var(--secondary);
      }

      .stat-footer {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
      }

      /* Expenses Breakdown */
      .expenses-breakdown {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: var(--space-6);
      }

      @media (min-width: 768px) {
        .expenses-breakdown {
          margin-bottom: var(--space-8);
        }
      }

      .expenses-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab-btn {
        flex: 1;
        min-width: 100px;
        padding: var(--space-3) var(--space-4);
        background: none;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 2px solid transparent;
        white-space: nowrap;
      }

      .tab-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: var(--bg-secondary);
      }

      .expenses-content {
        position: relative;
      }

      .tab-content {
        display: none;
        padding: var(--space-4);
        animation: contentFadeIn 0.3s ease-out;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes contentFadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (min-width: 768px) {
        .tab-content {
          padding: var(--space-6);
        }
      }

      .expenses-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
      }

      .expense-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
      }

      .expense-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .expense-category {
        font-weight: 500;
        color: var(--text-primary);
      }

      .expense-amount {
        font-weight: 600;
        color: var(--primary);
      }

      .expense-bar {
        height: 8px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
      }

      .expense-bar-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--primary-light)
        );
        transition: width 0.5s ease-out;
      }

      .expense-percentage {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: right;
      }

      .expenses-total {
        margin-top: var(--space-4);
        padding-top: var(--space-4);
        border-top: 1px solid var(--border-color);
        text-align: right;
        font-size: 1rem;
        font-weight: 600;
      }

      @media (min-width: 768px) {
        .expenses-total {
          margin-top: var(--space-6);
          font-size: 1.125rem;
        }
      }

      /* Loading State */
      .dashboard-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        font-size: 2.5rem;
        color: var(--primary);
      }

      @media (min-width: 768px) {
        .dashboard-loading {
          min-height: 400px;
          font-size: 3rem;
        }
      }

      /* ============================================
            PROGRESSIVE LOADING STATES
            ============================================ */
      .skeleton {
        background: linear-gradient(
          90deg,
          var(--bg-tertiary) 0%,
          var(--gray-200) 50%,
          var(--bg-tertiary) 100%
        );
        background-size: 200% 100%;
        animation: skeleton 1.5s ease-in-out infinite;
        border-radius: var(--radius);
      }

      @keyframes skeleton {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .skeleton-text {
        height: 1rem;
        margin-bottom: var(--space-2);
      }

      .skeleton-card {
        height: 120px;
      }

      /* ============================================
            SAFE AREA INSETS (iOS notch support)
            ============================================ */
      @supports (padding: max(0px)) {
        .header {
          padding-left: max(var(--space-4), env(safe-area-inset-left));
          padding-right: max(var(--space-4), env(safe-area-inset-right));
        }

        .content {
          padding-left: max(var(--space-4), env(safe-area-inset-left));
          padding-right: max(var(--space-4), env(safe-area-inset-right));
        }

        .sidebar {
          padding-bottom: max(var(--space-4), env(safe-area-inset-bottom));
        }

        .main-content {
          padding-bottom: max(60px, env(safe-area-inset-bottom));
        }

        @media (min-width: 768px) {
          .main-content {
            padding-bottom: 0;
          }
        }
      }

      /* Progressive Loading Animation */
      .progressive-fade-in {
        animation: fadeInUp 0.4s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal {
        min-width: 100%;
        min-height: 100vh;  
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: var(--z-index, 3000);
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
      }

      .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 480px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header,
      .modal-footer {
        padding: var(--space-4);
        border-bottom: 1px solid var(--border-color);
      }

      .modal-footer {
        border-top: none;
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
      }

      .modal-body {
        padding: var(--space-4);
        overflow-y: auto;
        max-height: 60vh;
      }
      .hidden {
        display: none !important;
      }
      .expea-header-btns {
        display: flex;
        justify-content: center;
      }

      /* Generic stats card wrapper */
      .stats-wrapper {
        margin-bottom: 1.5rem;
      }

      /* Card adjustments for stats */
      .stats-card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.3);
      }

      /* Stats row spacing */
      .stats-row {
        row-gap: 1rem;
      }

      /* Single stat column */
      .stats-col {
        padding: 0.5rem 0.75rem;
      }

      /* Label style */
      .stats-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-secondary, #6b7280);
        margin-bottom: 0.25rem;
      }

      /* Value style */
      .stats-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary, #111827);
      }

      /* Optional subtle divider between columns on desktop */
      @media (min-width: 768px) {
        .stats-col + .stats-col {
          border-left: 1px solid rgba(148, 163, 184, 0.3);
        }
      }

      /* Mobile responsiveness: 2 columns per row */
      @media (max-width: 767px) {
        .stats-row {
          display: flex;
          flex-wrap: wrap;
        }

        .stats-col {
          flex: 0 0 50%;
          max-width: 50%;
          padding: 0.5rem 0.5rem;
          border-left: none !important;
        }

        .stats-value {
          font-size: 1rem;
        }
      }


    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Content will be added in next part -->
    <div id="app">
      <!-- ============================================
            LOGIN PAGE
        ============================================ -->
      <div id="loginPage" class="login-page">
        <div class="login-container">
          <div class="login-card card">
            <div class="login-header">
              <div class="login-icon">
                <i class="fas fa-calculator"></i>
              </div>
              <h1 class="login-title">FFA Accounting</h1>
              <p class="login-subtitle">Sign in to your account</p>
            </div>

            <form id="loginForm" class="login-form">
              <div class="form-group">
                <label class="form-label required" for="loginPhone"
                  >Phone Number</label
                >
                <input
                  type="tel"
                  id="loginPhone"
                  class="form-input"
                  placeholder="Enter your phone number"
                  autocomplete="tel"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label required" for="loginPassword"
                  >Password</label
                >
                <input
                  type="password"
                  id="loginPassword"
                  class="form-input"
                  placeholder="Enter your password"
                  autocomplete="current-password"
                  required
                />
              </div>

              <button
                type="submit"
                class="btn btn-primary btn-lg w-full"
                id="loginButton"
              >
                <span id="loginButtonText">Sign In</span>
                <span id="loginButtonSpinner" class="spinner hidden"></span>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- ============================================
            DASHBOARD (Hidden initially)
        ============================================ -->
      <div id="dashboardPage" class="hidden">
        <div class="dashboard-layout">
          <!-- Sidebar -->
          <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
              <div class="sidebar-logo">
                <i class="fas fa-calculator"></i>
                <span>FFA Accounting</span>
              </div>
            </div>

            <nav class="sidebar-nav" id="sidebarNav">
              <!-- Navigation will be generated by JavaScript -->
            </nav>

            <div class="sidebar-footer">
              <button class="btn btn-secondary btn-sm w-full" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </button>
            </div>
          </aside>

          <!-- Main Content -->
          <div class="main-content">
            <header class="header">
              <button
                class="btn btn-icon btn-secondary mobile-menu-toggle"
                id="mobileMenuToggle"
              >
                <i class="fas fa-bars"></i>
              </button>

              <h1 class="header-title" id="pageTitle">Dashboard</h1>

              <div class="header-actions">
                <div class="user-info">
                  <i class="fas fa-user-circle"></i>
                  <span id="userName">Admin</span>
                  <span class="badge badge-primary" id="userRole">Admin</span>
                </div>
              </div>
            </header>

            <main class="content" id="mainContent">
              <!-- Content sections will be generated by JavaScript -->
            </main>
          </div>
        </div>
      </div>
    </div>
    <!-- End App Class -->

    <!-- Start Edit Expans -->

    <div id="expenseModal" class="modal hidden" style="--z-index: 3000">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="expenseModalTitle">Add Expense</h3>
          <button id="expenseModalClose" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="expenseForm">
            <div class="form-group">
              <label for="expenseAmount">Amount</label>
              <input
                id="expenseAmount"
                name="amount"
                type="number"
                step="0.01"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label for="expenseCategory">Category</label>
              <select
                id="expenseCategory"
                name="category_id"
                class="form-select"
                required
              >
                <option value="">Select category</option>
              </select>
            </div>
            <div class="form-group">
              <label for="expenseType">Type</label>
              <select id="expenseType" name="type" class="form-select" required>
                <option value="variable">Variable</option>
                <option value="fixed">Fixed</option>
              </select>
            </div>
            <div class="form-group">
              <label for="expenseVault">Vault</label>
              <select
                id="expenseVault"
                name="vault_id"
                class="form-select"
                required
              >
                <option value="">Select vault</option>
              </select>
            </div>
            <div class="form-group">
              <input type="hidden" id="expenseEmployee" name="employee_id" />
            </div>
            <div class="form-group">
              <label for="expenseDate">Date</label>
              <input
                id="expenseDate"
                name="date"
                type="date"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label for="expenseDescription">Description</label>
              <textarea
                id="expenseDescription"
                name="description"
                class="form-textarea"
                rows="3"
              ></textarea>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save</button>
              <button
                type="button"
                id="expenseCancelBtn"
                class="btn btn-secondary"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- End Edit Expans -->


    <!-- Start Vualt Modle -->
    
    <!-- Vault Modal -->
<div id="vaultModal" class="modal hidden" style="--z-index: 3000">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="vaultModalTitle">Add Vault</h3>
      <button id="vaultModalClose" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="vaultForm">
        <div class="form-group">
          <label for="vaultName">Vault Name</label>
          <input
            id="vaultName"
            name="name"
            type="text"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="vaultPaymentMethod">Payment Method</label>
          <select
            id="vaultPaymentMethod"
            name="payment_method"
            class="form-select"
            required
          >
            <option value="cash">Cash</option>
            <option value="bank">Bank</option>
            <option value="online">Online</option>
          </select>
        </div>

        <div class="form-group">
          <label for="vaultBalance">Initial Balance</label>
          <input
            id="vaultBalance"
            name="balance"
            type="number"
            step="0.01"
            class="form-input"
            value="0"
          />
        </div>

        <div class="form-group">
          <label for="vaultCommission">Commission Rate (%)</label>
          <input
            id="vaultCommission"
            name="commission_rate"
            type="number"
            step="0.01"
            class="form-input"
            value="0"
          />
        </div>

        <div class="form-group">
          <label for="vaultDefaultWarehouse">Default Warehouse</label>
          <input
            id="vaultDefaultWarehouse"
            name="default_warehouse"
            type="text"
            class="form-input"
            placeholder="Main warehouse"
          />
        </div>

        <div class="form-group">
          <label>
            <input
              type="checkbox"
              id="vaultIsDefault"
              name="is_default"
            />
            Set as default vault
          </label>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            id="vaultCancelBtn"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Save Vault
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Transfer Money Modal -->
<div id="transferModal" class="modal hidden" style="--z-index: 3000">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="transferModalTitle">Transfer Money</h3>
      <button id="transferModalClose" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="transferForm">
        <div class="form-group">
          <label for="fromVault">From Vault</label>
          <select
            id="fromVault"
            name="from_vault_id"
            class="form-select"
            required
          >
            <option value="">Select vault</option>
          </select>
        </div>

        <div class="form-group">
          <label for="toVault">To Vault</label>
          <select
            id="toVault"
            name="to_vault_id"
            class="form-select"
            required
          >
            <option value="">Select vault</option>
          </select>
        </div>

        <div class="form-group">
          <label for="transferAmount">Amount</label>
          <input
            id="transferAmount"
            name="amount"
            type="number"
            step="0.01"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="transferNote">Note (optional)</label>
          <textarea
            id="transferNote"
            name="note"
            class="form-textarea"
            rows="3"
          ></textarea>
        </div>
          <div class="form-group" style="display:none;">
            <input
              type="hidden"
              id="transferEmployee"
              name="employee_id"
            />
          </div>
        <div class="modal-footer">
          <button
            type="button"
            id="transferCancelBtn"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Transfer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Add Funds to Vault Modal -->
<div id="addFundsModal" class="modal hidden" style="--z-index: 3000">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="addFundsModalTitle">Add Funds to Vault</h3>
      <button id="addFundsModalClose" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addFundsForm">
        <!-- عرض اسم الخزنة فقط للقراءة -->
        <div class="form-group">
          <label>Vault</label>
          <input
            id="addFundsVaultName"
            type="text"
            class="form-input"
            readonly
          />
        </div>

        <div class="form-group">
          <label for="addFundsAmount">Amount</label>
          <input
            id="addFundsAmount"
            name="amount"
            type="number"
            step="0.01"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="addFundsNote">Note</label>
          <textarea
            id="addFundsNote"
            name="note"
            class="form-textarea"
            rows="3"
            required
          ></textarea>
        </div>

        <!-- hidden fields: vault_id + employee_id -->
        <div class="form-group" style="display:none;">
          <input type="hidden" id="addFundsVaultId" name="vault_id" />
        </div>
        <div class="form-group" style="display:none;">
          <input type="hidden" id="addFundsEmployeeId" name="employee_id" />
        </div>

        <div class="modal-footer">
          <button
            type="button"
            id="addFundsCancelBtn"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Add Funds
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- End Vualt Modle -->



    <!-- Start Advance / Bonus / Deduction Modal -->
<div id="payrollRequestModal" class="modal hidden" style="--z-index: 3000">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="payrollRequestModalTitle">New Payroll Request</h3>
      <button id="payrollRequestModalClose" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="payrollRequestForm">
        <div class="form-group">
          <label for="requestEmployee">Employee</label>
          <select
            id="requestEmployee"
            name="employee_id"
            class="form-select"
            required
          >
            <option value="">Select employee</option>
          </select>
        </div>

        <div class="form-group">
          <label for="requestType">Type</label>
          <select
            id="requestType"
            name="type"
            class="form-select"
            required
          >
            <option value="advance">Advance</option>
            <option value="bonus">Bonus</option>
            <option value="deduction">Deduction</option>
          </select>
        </div>

        <div class="form-group">
          <label for="requestAmount">Amount</label>
          <input
            id="requestAmount"
            name="amount"
            type="number"
            step="0.01"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="requestMonth">Month</label>
          <input
            id="requestMonth"
            name="month"
            type="month"
            class="form-input"
            required
          />
        </div>

        <div class="form-group">
          <label for="requestReason">Reason</label>
          <textarea
            id="requestReason"
            name="reason"
            class="form-textarea"
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              id="requestApproveNow"
              name="approve_now"
              checked
            />
            Approve and pay immediately
          </label>
          <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
            If checked, the request will be auto-approved and paid from the selected vault.
          </p>
        </div>

        <div
          class="form-group"
          id="requestVaultGroup"
        >
          <label for="requestVault">Vault (for immediate payment)</label>
          <select
            id="requestVault"
            name="vault_id"
            class="form-select"
          >
            <option value="">Select vault</option>
          </select>
          <p
            id="requestVaultHint"
            style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;"
          >
            Required when approving immediately.
          </p>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            id="payrollRequestCancelBtn"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Submit Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- End Advance / Bonus / Deduction Modal -->


<!-- START SHRMS LOGIN -->
<div id="shrmsLoginModal" class="modal hidden" style="--z-index: 3100">
  <div class="modal-content">
    <div class="modal-header">
      <h3>HR System Login</h3>
      <button id="shrmsLoginModalClose" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="shrmsLoginForm">
        <div class="form-group">
          <label for="shrmsPhone">Phone</label>
          <input
            id="shrmsPhone"
            name="phone"
            type="text"
            class="form-input"
            readonly
          />
        </div>
        <div class="form-group">
          <label for="shrmsPassword">Password</label>
          <input
            id="shrmsPassword"
            name="password"
            type="password"
            class="form-input"
            required
          />
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="shrmsLoginCancelBtn"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Login
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- END SHRMS LOGIN -->

    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Alerts Container -->
    <div class="alerts-container" id="alertsContainer"></div>


        <div id="tf-navigation"></div>

        <!-- External Scripts -->
        <script src="navigation.js"></script>



    <script>
      "use strict";

      // ============================================
      // CONFIGURATION
      // ============================================
      const CONFIG = {
        API_BASE:
          "https://tenderfrozen.com/wp-json/ffa/v1",
        SHRMS_API_BASE:
          "https://tenderfrozen.com/wp-json/shrms/v1",
        VERSION: "1.0.0",
        DEBUG_MODE: false,
        STORAGE_PREFIX: "ffa_",

        // ✅ Cache TTLs (optimized)
        CACHE_TTL: {
        //   vaults: 2 * 60 * 1000, // 2 minutes
          vaults: 5 * 1000, // 5 seconds
          categories: 10 * 60 * 1000, // 10 minutes
          employees: 5 * 60 * 1000, // 5 minutes
          dashboard: 1 * 60 * 1000, // 1 minute
          sections: 3 * 60 * 1000, // 3 minutes (for rendered sections)
        },

        // ✅ Auto-refresh intervals
        AUTO_REFRESH: {
          dashboard: 30 * 1000, // 30 seconds
          enabled: true,
        },

        API_TIMEOUT: 10000,
      };

      // ============================================
      // ENHANCED STATE MANAGEMENT
      // ============================================
      const STATE = {
        user: null,
        userRole: null,
        token: null,
        cache: {},
        sectionCache: {}, // ✅ Cache for rendered sections
        currentSection: "dashboard",
        loadingStates: {}, // ✅ Track loading per section
        autoRefreshIntervals: {}, // ✅ Auto-refresh timers

        set(key, value) {
          const oldValue = this[key];
          this[key] = value;
          Logger.state(`SET ${key}`, oldValue, value);

          if (key === "token") {
            localStorage.setItem(CONFIG.STORAGE_PREFIX + "token", value);
          } else if (key === "user") {
            localStorage.setItem(
              CONFIG.STORAGE_PREFIX + "user",
              JSON.stringify(value)
            );
          }
        },

        get(key) {
          return this[key];
        },

        clear() {
          Logger.info("Clearing state");
          this.clearAutoRefresh(); // ✅ Stop all auto-refresh
          this.user = null;
          this.token = null;
          this.cache = {};
          this.sectionCache = {};
          this.loadingStates = {};
          localStorage.removeItem(CONFIG.STORAGE_PREFIX + "token");
          localStorage.removeItem(CONFIG.STORAGE_PREFIX + "user");
        },

        // ✅ Enhanced cache with different TTLs
        setCache(key, value, ttl) {
          const finalTTL =
            ttl || CONFIG.CACHE_TTL[key] || CONFIG.CACHE_TTL.vaults;
          this.cache[key] = {
            data: value,
            timestamp: Date.now(),
            ttl: finalTTL,
          };
          Logger.log(`Cache set: ${key} (TTL: ${finalTTL}ms)`);
        },

        getCache(key, ignoreExpiry = false) {
          const cached = this.cache[key];
          if (!cached) return null;

          if (!ignoreExpiry && Date.now() - cached.timestamp > cached.ttl) {
            Logger.log(`Cache expired: ${key}`);
            delete this.cache[key];
            return null;
          }

          Logger.log(`Cache hit: ${key}`);
          return cached.data;
        },

        clearCache(key) {
          if (key) {
            delete this.cache[key];
            Logger.log(`Cache cleared: ${key}`);
          } else {
            Logger.info("Clearing all cache");
            this.cache = {};
          }
        },

        // ✅ Section cache management
        setSectionCache(section, html) {
          this.sectionCache[section] = {
            html: html,
            timestamp: Date.now(),
            ttl: CONFIG.CACHE_TTL.sections,
          };
          Logger.log(`Section cached: ${section}`);
        },

        getSectionCache(section) {
          const cached = this.sectionCache[section];
          if (!cached) return null;

          if (Date.now() - cached.timestamp > cached.ttl) {
            Logger.log(`Section cache expired: ${section}`);
            delete this.sectionCache[section];
            return null;
          }

          Logger.log(`Section cache hit: ${section}`);
          return cached.html;
        },

        clearSectionCache(section) {
          if (section) {
            delete this.sectionCache[section];
            Logger.log(`Section cache cleared: ${section}`);
          } else {
            this.sectionCache = {};
            Logger.log("All section cache cleared");
          }
        },

        // ✅ Loading states
        setLoading(key, isLoading) {
          this.loadingStates[key] = isLoading;
        },

        isLoading(key) {
          return this.loadingStates[key] || false;
        },

        // ✅ Auto-refresh management
        setAutoRefresh(key, callback, interval) {
          this.clearAutoRefresh(key);

          if (CONFIG.AUTO_REFRESH.enabled && interval) {
            this.autoRefreshIntervals[key] = setInterval(callback, interval);
            Logger.log(`Auto-refresh enabled: ${key} (${interval}ms)`);
          }
        },

        clearAutoRefresh(key) {
          if (key) {
            if (this.autoRefreshIntervals[key]) {
              clearInterval(this.autoRefreshIntervals[key]);
              delete this.autoRefreshIntervals[key];
              Logger.log(`Auto-refresh cleared: ${key}`);
            }
          } else {
            Object.keys(this.autoRefreshIntervals).forEach((k) => {
              clearInterval(this.autoRefreshIntervals[k]);
            });
            this.autoRefreshIntervals = {};
            Logger.log("All auto-refresh cleared");
          }
        },

          shrmsToken: null,
          setShrmsToken(token) {
            Logger.state("SET shrmsToken", {
              Old: this.shrmsToken,
              New: token,
            });
            this.shrmsToken = token;
            localStorage.setItem(CONFIG.STORAGE_PREFIX + "shrmsToken", token);
          },

          getShrmsToken() {
            if (!this.shrmsToken) {
              this.shrmsToken =
                localStorage.getItem(CONFIG.STORAGE_PREFIX + "shrmsToken") || null;
            }
            return this.shrmsToken;
          },

          clearShrmsToken() {
            Logger.state("CLEAR shrmsToken");
            this.shrmsToken = null;
            localStorage.removeItem(CONFIG.STORAGE_PREFIX + "shrmsToken");
          },
      };

      // ============================================
      // API LAYER
      // ============================================
      const API = {
        async request(endpoint, options = {}) {
          const baseUrl = options.baseUrl || CONFIG.API_BASE;
          const url = `${baseUrl}${endpoint}`;

          const ffaToken = STATE.get("token");
          const shrmsToken = STATE.getShrmsToken();

          const config = {
            method: options.method || "GET",
            headers: {
              "Content-Type": "application/json",
              // FFA token للـ FFA API
              ...(baseUrl === CONFIG.API_BASE && ffaToken && {
                Authorization: `Bearer ${ffaToken}`,
              }),
              // SHRMS token للـ SHRMS API
              ...(baseUrl === CONFIG.SHRMS_API_BASE && shrmsToken && {
                Authorization: `Bearer ${shrmsToken}`,
              }),
              ...options.headers,
            },
            ...options,
          };

          Logger.log(`API Request: ${config.method} ${endpoint}`);
          Logger.log(`Full URL: ${url}`);


          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(
              () => controller.abort(),
              CONFIG.API_TIMEOUT
            );

            const response = await fetch(url, {
              ...config,
              signal: controller.signal,
            });

            clearTimeout(timeoutId);

            Logger.log(
              `Response Status: ${response.status} ${response.statusText}`
            );

            let data;
            try {
              data = await response.json();
            } catch (parseError) {
              Logger.error("Failed to parse JSON response:", parseError);
              throw new Error(
                "Invalid server response. Please check if plugin is active."
              );
            }

            Logger.api(config.method, endpoint, options.body, data);

             if (!response.ok) {
              if (response.status === 401) {
                if (baseUrl === CONFIG.API_BASE) {
                  Logger.warn("Unauthorized from FFA API - logging out");
                  APP.logout();
                  throw new Error("Session expired. Please login again.");
                } else {
                  Logger.warn("Unauthorized from external API", {
                    baseUrl,
                    endpoint,
                  });
                  throw new Error("External API unauthorized");
                }
              }

              if (response.status === 403) {
                throw new Error("Access denied. Admin permissions required.");
              }

              if (response.status === 404) {
                throw new Error(
                  "API endpoint not found. Please check if FFA plugin is installed."
                );
              }

              if (response.status === 500) {
                throw new Error(
                  "Server error. Please check WordPress error logs."
                );
              }

              throw new Error(
                data.message ||
                  `HTTP ${response.status}: ${response.statusText}`
              );
            }

            return data;
          } catch (error) {
            if (error.name === "AbortError") {
              Logger.error("Request timeout");
              throw new Error(
                "Request timeout. Please check your internet connection."
              );
            }

            if (error.message === "Failed to fetch") {
              Logger.error("Network error - possible CORS or connection issue");
              Logger.error("URL:", url);
              Logger.error("Make sure:");
              Logger.error("1. Plugin is active on WordPress");
              Logger.error("2. URL is correct");
              Logger.error("3. CORS is enabled");

              throw new Error(
                "Cannot connect to server. Possible issues:\n" +
                  "1. Check if FFA plugin is active\n" +
                  "2. Verify API URL is correct\n" +
                  "3. Check CORS settings\n" +
                  "4. Check internet connection"
              );
            }

            Logger.error("API Error:", error);
            throw error;
          }
        },

        // Authentication
        async login(phone, password) {
          Logger.info("Attempting login", { phone });
          return this.request("/auth/login", {
            method: "POST",
            body: JSON.stringify({ phone, password }),
          });
        },

        // SHRMS Authentication
        async shrmsLogin(phone, password) {
          Logger.info("Attempting SHRMS login", { phone });
          return this.request("/auth/login", {
            method: "POST",
            baseUrl: CONFIG.SHRMS_API_BASE,
            body: JSON.stringify({ phone, password }),
          });
        },


        // Dashboard
        async getDashboard() {
          return this.request("/dashboard");
        },

        // Expenses
        async getExpenses(params = {}) {
          const query = new URLSearchParams(params).toString();
          return this.request(`/expenses${query ? "?" + query : ""}`);
        },

        // Categories
        async getCategories() {
          const cached = STATE.getCache("categories");
          if (cached) return cached;

          const response = await this.request("/expense-categories");
          STATE.setCache("categories", response);
          return response;
        },

        // Vaults
        async getVaults() {
          const cached = STATE.getCache("vaults");
          if (cached) return cached;

          const response = await this.request("/vaults");

          // قراءة بيانات اليوزر من اللوكال ستورج
          const user = JSON.parse(localStorage.getItem("ffa_user"));

          // لو سوبر أدمن → رجّع زي ما هو
          if (user?.role === "super_admin") {
            STATE.setCache("vaults", response);
            return response;
          }

          // لو أدمن → فلترة حسب IDs معينة
          if (user?.role === "admin") {
            const ADMIN_ALLOWED_VAULTS = ["16"]; 

            const filtered = {
              ...response,
              data: response.data.filter(v => ADMIN_ALLOWED_VAULTS.includes(v.id))
            };

            STATE.setCache("vaults", filtered);
            return filtered;
          }

          // أي رول تاني → رجّع الريسبونس كامل (اختياري)
          STATE.setCache("vaults", response);
          return response;
        },

        async createVault(data) {
          return this.request("/vaults", {
            method: "POST",
            body: JSON.stringify(data),
          });
        },

        async updateVault(id, data) {
          return this.request(`/vaults/${id}`, {
            method: "PUT",
            body: JSON.stringify(data),
          });
        },

        async deleteVault(id) {
          return this.request(`/vaults/${id}`, {
            method: "DELETE",
          });
        },

        async transferBetweenVaults(data) {
          return this.request("/vaults/transfer", {
            method: "POST",
            body: JSON.stringify(data),
          });
        },

        // Add funds to vault
        async addFundsToVault(data) {
          Logger.log("API.addFundsToVault called with:", data);
          return this.request("/vaults/add-funds", {
            method: "POST",
            body: JSON.stringify(data),
          });
        },

        // Cashflow
        async getCashflow(params = {}) {
          const query = new URLSearchParams(params).toString();
          return this.request(`/cashflow${query ? "?" + query : ""}`);
        },

        // Payroll - list salaries (integrated with SHRMS via FFA)
        async getPayroll(params = {}) {
          Logger.log("API.getPayroll called with params:", params);

          const query = new URLSearchParams(params).toString();
          const url = query ? `/payroll?${query}` : "/payroll";

          return this.request(url);
        },

        // Payroll - pay a specific salary
        async paySalary(data) {
          Logger.log("API.paySalary called with:", data);
          return this.request("/payroll/pay", {
            method: "POST",
            body: JSON.stringify(data),
          });
        },

        // SHRMS Payroll calculation (called from FFA UI when needed)
        async calculatePayroll(params = {}) {
          Logger.log("API.calculatePayroll called with:", params);
          const url = "/payroll/calculate";
          return this.request(url, {
            method: "POST",
            baseUrl: CONFIG.SHRMS_API_BASE,  // مهم: هذا endpoint من SHRMS
            body: JSON.stringify(params),
          });
        },

        // SHRMS - Payroll Requests
        async getRequests(params = {}) {
          Logger.log("API.getRequests called with:", params); 
          const query = new URLSearchParams(params).toString();
          const url = query ? `/requests?${query}` : "/requests";
          return this.request(url, { baseUrl: CONFIG.SHRMS_API_BASE });
        },

        async createRequest(data) {
          Logger.log("API.createRequest called with:", data);
          return this.request("/requests", {
            method: "POST",
            baseUrl: CONFIG.SHRMS_API_BASE,
            body: JSON.stringify(data),
          });
        },

        async approveRequest(id, data = {}) {
          Logger.log("API.approveRequest called for id:", id, "data:", data);
          return this.request(`/requests/${id}/approve`, {
            method: "POST",
            baseUrl: CONFIG.SHRMS_API_BASE,
            body: Object.keys(data).length ? JSON.stringify(data) : undefined,
          });
        },

        // Company loans
        async getCompanyLoans(params = {}) {
          Logger.log("API.getCompanyLoans called with:", params);
          const query = new URLSearchParams(params).toString();
          const endpoint = query ? `/company-loans?${query}` : "/company-loans";
          return this.request(endpoint, {
            method: "GET",
            baseUrl: CONFIG.API_BASE, // نفس base بتاع ffa/v1
          });
        },

        async createCompanyLoan(payload) {
          Logger.log("API.createCompanyLoan called with:", payload);
          return this.request("/company-loans", {
            method: "POST",
            baseUrl: CONFIG.API_BASE,
            body: JSON.stringify(payload),
          });
        },

        async deleteCompanyLoan(id) {
          Logger.log("API.deleteCompanyLoan called for id:", id);
          return this.request(`/company-loans/${id}`, {
            method: "DELETE",
            baseUrl: CONFIG.API_BASE,
          });
        },

        // Employee loans
        async getEmployeeLoans(params = {}) {
          Logger.log("API.getEmployeeLoans called with:", params);
          const query = new URLSearchParams(params).toString();
          const endpoint = query ? `/employee-loans?${query}` : "/employee-loans";
          return this.request(endpoint, {
            method: "GET",
            baseUrl: CONFIG.API_BASE,
          });
        },

        async createEmployeeLoan(payload) {
          Logger.log("API.createEmployeeLoan called with:", payload);
          return this.request("/employee-loans", {
            method: "POST",
            baseUrl: CONFIG.API_BASE,
            body: JSON.stringify(payload),
          });
        },

        async deleteEmployeeLoan(id) {
          Logger.log("API.deleteEmployeeLoan called for id:", id);
          return this.request(`/employee-loans/${id}`, {
            method: "DELETE",
            baseUrl: CONFIG.API_BASE,
          });
        },

        // Loan payments
        async getLoanPayments(params = {}) {
          Logger.log("API.getLoanPayments called with:", params);
          const query = new URLSearchParams(params).toString();
          const endpoint = query ? `/loan-payments?${query}` : "/loan-payments";
          return this.request(endpoint, {
            method: "GET",
            baseUrl: CONFIG.API_BASE,
          });
        },

        async createLoanPayment(payload) {
          Logger.log("API.createLoanPayment called with:", payload);
          return this.request("/loan-payments", {
            method: "POST",
            baseUrl: CONFIG.API_BASE,
            body: JSON.stringify(payload),
          });
        },



      };

      // ============================================
      // LOGGING SYSTEM (for development)
      // ============================================
      const Logger = {
        enabled: CONFIG.DEBUG_MODE,

        log(...args) {
          if (!this.enabled) return;
          console.log("[FFA LOG]", new Date().toISOString(), ...args);
        },

        info(...args) {
          if (!this.enabled) return;
          console.info("[FFA INFO]", new Date().toISOString(), ...args);
        },

        warn(...args) {
          if (!this.enabled) return;
          console.warn("[FFA WARN]", new Date().toISOString(), ...args);
        },

        error(...args) {
          if (!this.enabled) return;
          console.error("[FFA ERROR]", new Date().toISOString(), ...args);
        },

        api(method, endpoint, data, response) {
          if (!this.enabled) return;
          console.group(`[FFA API] ${method} ${endpoint}`);
          console.log("Request:", data);
          console.log("Response:", response);
          console.log("Time:", new Date().toISOString());
          console.groupEnd();
        },

        state(action, oldState, newState) {
          if (!this.enabled) return;
          console.group(`[FFA STATE] ${action}`);
          console.log("Old:", oldState);
          console.log("New:", newState);
          console.groupEnd();
        },

        clear() {
          if (!this.enabled) return;
          console.clear();
        },
      };

      // ============================================
      // UI COMPONENTS (Enhanced)
      // ============================================
      const UI = {
        showToast(message, type = "info", duration = 5000) {
          Logger.log(`Toast: ${type} - ${message}`);

          const container = document.getElementById("toastContainer");
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;

          const icons = {
            success: "fa-check-circle",
            error: "fa-exclamation-circle",
            warning: "fa-exclamation-triangle",
            info: "fa-info-circle",
          };

          toast.innerHTML = `
                        <div class="toast-icon">
                            <i class="fas ${icons[type]}"></i>
                        </div>
                        <div class="toast-content">
                            <div class="toast-message">${message}</div>
                        </div>
                        <button class="toast-close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

          container.appendChild(toast);

          if (duration > 0) {
            setTimeout(() => toast.remove(), duration);
          }
        },

        showPage(pageId) {
          Logger.info(`Showing page: ${pageId}`);

          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardPage").classList.add("hidden");
          document.getElementById(pageId).classList.remove("hidden");
        },

        showLoading(message = "Loading...") {
          let loadingOverlay = document.getElementById("loadingOverlay");
          if (!loadingOverlay) {
            loadingOverlay = document.createElement("div");
            loadingOverlay.id = "loadingOverlay";
            loadingOverlay.style.position = "fixed";
            loadingOverlay.style.top = "0";
            loadingOverlay.style.left = "0";
            loadingOverlay.style.right = "0";
            loadingOverlay.style.bottom = "0";
            loadingOverlay.style.background = "rgba(255, 255, 255, 0.7)";
            loadingOverlay.style.zIndex = "9999";
            loadingOverlay.style.display = "flex";
            loadingOverlay.style.alignItems = "center";
            loadingOverlay.style.justifyContent = "center";
            loadingOverlay.style.fontSize = "1.5rem";
            loadingOverlay.style.color = "#333";
            loadingOverlay.innerText = message;
            document.body.appendChild(loadingOverlay);
          } else {
            loadingOverlay.innerText = message;
            loadingOverlay.style.display = "flex";
          }
        },

        hideLoading() {
          const loadingOverlay = document.getElementById("loadingOverlay");
          if (loadingOverlay) {
            loadingOverlay.style.display = "none";
          }
        },

        // ✅ Skeleton screen for loading
        showSkeleton(container, type = "default") {
          const skeletons = {
            stats: `
                            <div class="stats-grid">
                                ${Array(4)
                                  .fill("")
                                  .map(
                                    () => `
                                    <div class="stat-card">
                                        <div class="skeleton skeleton-text" style="width: 60%; margin-bottom: 1rem;"></div>
                                        <div class="skeleton skeleton-text" style="width: 80%; height: 2rem; margin-bottom: 0.5rem;"></div>
                                        <div class="skeleton skeleton-text" style="width: 40%;"></div>
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        `,
            table: `
                            <div class="card">
                                <div class="card-header">
                                    <div class="skeleton skeleton-text" style="width: 200px;"></div>
                                </div>
                                <div class="card-body">
                                    ${Array(5)
                                      .fill("")
                                      .map(
                                        () => `
                                        <div class="skeleton skeleton-text" style="margin-bottom: 0.75rem;"></div>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>
                        `,
            default: `
                            <div class="card">
                                <div class="card-body">
                                    <div class="skeleton skeleton-card"></div>
                                </div>
                            </div>
                        `,
          };

          container.innerHTML = skeletons[type] || skeletons.default;
        },

        // ✅ Progressive content loader
        showProgressiveContent(container, sections) {
          // Show skeleton first
          this.showSkeleton(container, "stats");

          // Load sections progressively
          sections.forEach((section, index) => {
            setTimeout(() => {
              const placeholder = container.querySelector(".stats-grid");
              if (placeholder && section.element) {
                if (index === 0) {
                  placeholder.innerHTML = section.element;
                } else {
                  placeholder.insertAdjacentHTML("beforeend", section.element);
                }
              }
            }, section.delay || index * 100);
          });
        },

        // ✅ Update specific section without full reload
        updateSection(sectionId, newContent) {
          const element = document.getElementById(sectionId);
          if (element) {
            element.style.opacity = "0.5";
            setTimeout(() => {
              element.innerHTML = newContent;
              element.style.opacity = "1";
              Logger.log(`Section updated: ${sectionId}`);
            }, 150);
          }
        },

        transitionContent(container, newContent, callback) {
    if (!container) {
        Logger.error("transitionContent: container is undefined");
        return;
    }

    // Clear previous content and any loading indicators explicitly
    container.innerHTML = "";
    container.style.opacity = "0";
    container.style.transition = "opacity 0.2s ease";

    setTimeout(() => {
        try {
            container.innerHTML = newContent;

            // Hide any loading indicators inside container if present
            container.querySelectorAll(".spinner, .skeleton").forEach((el) => {
                el.classList.add("hidden");
            });

            container.style.opacity = "1";

            Logger.log("Content transitioned and cleaned");

            // Small delay to ensure stable DOM before binding events
            setTimeout(() => {
                if (callback) callback();
            }, 30);
        } catch (error) {
            Logger.error("Error in transitionContent:", error);
            container.style.opacity = "1";
        }
    }, 200);


          // Clear all loaders/spinners inside the container to avoid leftover loading UI
          container.querySelectorAll(".spinner, .skeleton").forEach((el) => {
            el.classList.add("hidden");
          });
        },
      };

      // ============================================
      // AUTHENTICATION
      // ============================================
      const Auth = {
        async login(phone, password) {
          try {
            UI.showLoading("Logging in...");

            const response = await API.login(phone, password);

            if (response.status === "success") {
              STATE.set("token", response.data.token);
              STATE.set("user", response.data.employee);

              // Clear cache related to expenses to force reload fresh data
              STATE.clearSectionCache("expenses");
              STATE.clearCache("expenses");

              UI.hideLoading(); // Hide loading overlay
              Logger.info("Login successful", response.data.employee);
              UI.showToast("Welcome back!", "success");
              APP.initDashboard();

              // Optionally reload expenses section if current section is expenses
              setTimeout(() => {
                if (STATE.currentSection === "expenses") {
                  APP.loadSection("expenses", true);
                }
              }, 1000);
            } else {
              throw new Error(response.message || "Login failed");
            }
          } catch (error) {
            Logger.error("Login failed", error);
            UI.hideLoading(); // Ensure loading overlay is hidden in error case
            UI.showToast(error.message, "error");
          }
        },

        logout() {
          Logger.info("Logging out");
          STATE.clear();
          UI.showPage("loginPage");
          UI.showToast("Logged out successfully", "info");
          // Stop all auto-refresh
          STATE.clearAutoRefresh();
        },

        checkAuth() {
          const token = localStorage.getItem(CONFIG.STORAGE_PREFIX + "token");
          const user = localStorage.getItem(CONFIG.STORAGE_PREFIX + "user");

          if (token && user) {
            Logger.info("Restoring session");
            STATE.set("token", token);
            STATE.set("user", JSON.parse(user));
            return true;
          }

          return false;
        },
      };

      // ============================================
      // APP INITIALIZATION
      // ============================================
      const APP = {
        init() {
          Logger.info("Initializing FFA Accounting System", CONFIG);

          this.setupEventListeners();

          if (Auth.checkAuth()) {
            this.initDashboard();
          } else {
            UI.showPage("loginPage");
          }
        },

  setupEventListeners() {
  // Login form
  const loginForm = document.getElementById("loginForm");
  if (loginForm) {
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const phone = document.getElementById("loginPhone").value;
      const password = document.getElementById("loginPassword").value;
      await Auth.login(phone, password);
    });
  }

  // Logout button
  const logoutButton = document.getElementById("logoutButton");
  if (logoutButton) {
    logoutButton.addEventListener("click", () => {
      Auth.logout();
    });
  }

  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById("mobileMenuToggle");
  if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("show");
    });
  }

  // Close sidebar on navigation (mobile)
  document.addEventListener("click", (e) => {
    if (window.innerWidth <= 768) {
      const sidebar = document.getElementById("sidebar");
      const toggle = document.getElementById("mobileMenuToggle");

      if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove("show");
      }
    }
  });

  // Expenses tabs switching
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("tab-btn")) {
      const tab = e.target.dataset.tab;

      // Update buttons
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.classList.remove("active");
      });
      e.target.classList.add("active");

      // Update content
      document.querySelectorAll(".tab-content").forEach((content) => {
        content.classList.remove("active");
      });
      document
        .querySelector(`[data-content="${tab}"]`)
        ?.classList.add("active");

      Logger.log(`Switched to expenses tab: ${tab}`);
    }
  });

  // Vault form submit
  const vaultForm = document.getElementById("vaultForm");
  if (vaultForm) {
    Logger.log("Binding submit event for vaultForm");
    vaultForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      Logger.log("vaultForm submitted");

      const modal = document.getElementById("vaultModal");

      const data = {
        name: vaultForm.name.value,
        payment_method: vaultForm.payment_method.value,
        balance: vaultForm.balance.value,
        commission_rate: vaultForm.commission_rate.value,
        default_warehouse: vaultForm.default_warehouse.value,
        is_default: vaultForm.is_default.checked,
      };

      Logger.log("Vault form data prepared:", data);

      await APP.addVault(data);

      if (modal) {
        modal.classList.add("hidden");
        Logger.log("vaultModal hidden after successful submit");
      }
    });
  }

  // Transfer form submit
  const transferForm = document.getElementById("transferForm");
  if (transferForm) {
    Logger.log("Binding submit event for transferForm");
    transferForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      Logger.log("transferForm submitted");

      const modal = document.getElementById("transferModal");

      const data = {
        from_vault_id: transferForm.from_vault_id.value,
        to_vault_id: transferForm.to_vault_id.value,
        amount: parseFloat(transferForm.amount.value || "0"),
        note: transferForm.note.value.trim() || null,
        employee_id: transferForm.employee_id.value || STATE.user?.id || null,
      };

      Logger.log("Transfer form data prepared:", data);

      await APP.transferMoney(data);

      if (modal) {
        modal.classList.add("hidden");
        Logger.log("Transfer modal closed after submit");
      }
    });
  } else {
    Logger.warn("transferForm not found in DOM");
  }

  // Add funds form submit
  const addFundsForm = document.getElementById("addFundsForm");
  if (addFundsForm) {
    Logger.log("Binding submit event for addFundsForm");
    addFundsForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      Logger.log("addFundsForm submitted");

      const modal = document.getElementById("addFundsModal");

      const payload = {
        vault_id: addFundsForm.vault_id.value,
        amount: parseFloat(addFundsForm.amount.value || "0"),
        employee_id: addFundsForm.employee_id.value || STATE.user?.id || null,
        note: addFundsForm.note.value.trim(),
      };

      Logger.log("addFunds payload prepared:", payload);

      await APP.addFundsToVault(payload);

      if (modal) {
        modal.classList.add("hidden");
        Logger.log("Add funds modal hidden after submit");
      }
    });
  } else {
    Logger.warn("addFundsForm not found in DOM");
  }

  // Vault modal close / cancel (buttons inside modals)
  const closeVaultModalBtn = document.getElementById("closeVaultModalBtn");
  const cancelVaultBtn = document.getElementById("cancelVaultBtn");
  if (closeVaultModalBtn) {
    closeVaultModalBtn.addEventListener("click", () => {
      Logger.log("closeVaultModalBtn clicked");
      document.getElementById("vaultModal")?.classList.add("hidden");
    });
  }
  if (cancelVaultBtn) {
    cancelVaultBtn.addEventListener("click", () => {
      Logger.log("cancelVaultBtn clicked");
      document.getElementById("vaultModal")?.classList.add("hidden");
    });
  }

  // Transfer modal close / cancel
  const closeTransferModalBtn = document.getElementById("closeTransferModalBtn");
  const cancelTransferBtn = document.getElementById("cancelTransferBtn");
  if (closeTransferModalBtn) {
    closeTransferModalBtn.addEventListener("click", () => {
      Logger.log("closeTransferModalBtn clicked");
      document.getElementById("transferModal")?.classList.add("hidden");
    });
  }
  if (cancelTransferBtn) {
    cancelTransferBtn.addEventListener("click", () => {
      Logger.log("cancelTransferBtn clicked");
      document.getElementById("transferModal")?.classList.add("hidden");
    });
  }

  // Add funds modal close / cancel
  const addFundsModalClose = document.getElementById("addFundsModalClose");
  const addFundsCancelBtn = document.getElementById("addFundsCancelBtn");
  if (addFundsModalClose) {
    addFundsModalClose.addEventListener("click", () => {
      Logger.log("addFundsModalClose clicked");
      document.getElementById("addFundsModal")?.classList.add("hidden");
    });
  }
  if (addFundsCancelBtn) {
    addFundsCancelBtn.addEventListener("click", () => {
      Logger.log("addFundsCancelBtn clicked");
      document.getElementById("addFundsModal")?.classList.add("hidden");
    });
  }

  // SHRMS login form
  const shrmsLoginForm = document.getElementById("shrmsLoginForm");
  if (shrmsLoginForm) {
    shrmsLoginForm.addEventListener("submit", (e) =>
      APP.handleShrmsLoginSubmit(e)
    );
  }

  const shrmsLoginClose = document.getElementById("shrmsLoginModalClose");
  const shrmsLoginCancel = document.getElementById("shrmsLoginCancelBtn");
  [shrmsLoginClose, shrmsLoginCancel].forEach((btn) => {
    if (btn) {
      btn.addEventListener("click", () => {
        document.getElementById("shrmsLoginModal")?.classList.add("hidden");
      });
    }
  });

  // Payroll request form submit (HR request)
  const payrollRequestForm = document.getElementById("payrollRequestForm");
  if (payrollRequestForm) {
    payrollRequestForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      Logger.log("payrollRequestForm submitted");

      const approveNow =
        document.getElementById("requestApproveNow")?.checked || false;
      const vaultId = document.getElementById("requestVault")?.value || "";

      const payload = {
        employee_id: Number(payrollRequestForm.employee_id.value),
        type: payrollRequestForm.type.value,
        amount: parseFloat(payrollRequestForm.amount.value || "0"),
        month: payrollRequestForm.month.value || null,
        reason: payrollRequestForm.reason.value || "",
      };

      Logger.log("Submitting payroll request payload:", payload, {
        approveNow,
        vaultId,
      });

      if (approveNow && !vaultId) {
        UI.showToast("Please select a vault for immediate approval", "error");
        return;
      }

      await APP.submitPayrollRequest(payload, { approveNow, vaultId });

      document
        .getElementById("payrollRequestModal")
        ?.classList.add("hidden");
    });
  }

  const reqCancel = document.getElementById("payrollRequestCancelBtn");
  if (reqCancel) {
    reqCancel.addEventListener("click", () => {
      Logger.log("Payroll request modal cancel clicked");
      document
        .getElementById("payrollRequestModal")
        ?.classList.add("hidden");
    });
  }

  // === Global click handler (one handler for many buttons) ===
  document.addEventListener("click", (e) => {
    const target = e.target;

    // 1) Vaults - Add vault
    if (target.closest && target.closest("#addVaultBtn")) {
      Logger.log("Global handler: addVaultBtn clicked");
      APP.showAddVaultModal();
      return;
    }

    // 2) Vaults - Transfer money
    if (target.closest && target.closest("#transferMoneyBtn")) {
      Logger.log("Global handler: transferMoneyBtn clicked");
      APP.showTransferMoneyModal();
      return;
    }

    // 3) Vaults - Delete vault
    const deleteBtn = target.closest?.('[data-action="delete-vault"]');
    if (deleteBtn) {
      const vaultId = deleteBtn.dataset.id;
      Logger.log("Global handler: delete-vault clicked for id:", vaultId);
      APP.deleteVault(vaultId);
      return;
    }

    // 4) Vaults - Add funds
    const addFundsBtn = target.closest?.('[data-action="add-funds"]');
    if (addFundsBtn) {
      const vaultId = addFundsBtn.dataset.id;
      const vaultName = addFundsBtn.dataset.name;
      Logger.log("Global handler: add-funds clicked", { vaultId, vaultName });
      APP.showAddFundsModal(vaultId, vaultName);
      return;
    }

    // 5) Payroll - Pay salary
    const payBtn = target.closest(".payroll-pay-btn");
    if (payBtn) {
      const salaryId = payBtn.dataset.salaryId;
      const employeeId = payBtn.dataset.employeeId;
      const amount = Number(payBtn.dataset.amount || 0);
      const employeeName = payBtn.dataset.employeeName || "";
      const select = document.querySelector(
        `.payroll-vault-select[data-salary-id="${salaryId}"]`
      );
      const vaultId = select?.value || "";

      Logger.log("Global handler: Pay button clicked:", {
        salaryId,
        employeeId,
        vaultId,
        amount,
        employeeName,
      });

      if (!vaultId) {
        UI.showToast("Please select a vault first", "error");
        return;
      }

      APP.paySalary({
        salary_id: Number(salaryId),
        vault_id: Number(vaultId),
        employee_id: Number(employeeId),
        amount,
      });

      return;
    }

    // 6) Payroll - Calculate payroll
    const calcBtn = target.closest("#calculatePayrollBtn");
    if (calcBtn) {
      Logger.log("Global handler: Calculate payroll button clicked");
      (async () => {
        try {
          UI.showLoading("Calculating payroll...");
          const resp = await API.calculatePayroll({});
          Logger.log("Payroll calculated:", resp);
          UI.showToast("Payroll calculated successfully", "success");
          STATE.clearSectionCache("payroll");
          await APP.loadSection("payroll", true);
        } catch (error) {
          Logger.error("Failed to calculate payroll:", error);
          UI.showToast(
            "Failed to calculate payroll: " + error.message,
            "error"
          );
        } finally {
          UI.hideLoading();
        }
      })();
      return;
    }

    // 7) Payroll - Open create request modal
    const createReqBtnClick = target.closest("#createRequestBtn");
    if (createReqBtnClick) {
      Logger.log("Global handler: createRequestBtn clicked");
      APP.showPayrollRequestModal();
      return;
    }

    // 8) Payroll - Close / cancel request modal
    const closeReq =
      target.closest("#payrollRequestModalClose") ||
      target.closest("#payrollRequestCancelBtn");
    if (closeReq) {
      Logger.log("Global handler: payroll request modal close/cancel clicked");
      document
        .getElementById("payrollRequestModal")
        ?.classList.add("hidden");
      return;
    }

    // 9) Payroll - Approve payroll request from requests table
    const approveReqBtn = target.closest(".payroll-request-approve-btn");
    if (approveReqBtn) {
      const requestId = approveReqBtn.dataset.requestId;
      const row = approveReqBtn.closest("tr");
      const vaultSelect = row?.querySelector(".request-vault-select");
      const vaultId = vaultSelect?.value || "";

      Logger.log("Approve payroll request clicked:", {
        requestId,
        vaultId,
      });

      if (!vaultId) {
        UI.showToast("Please select a vault first", "error");
        return;
      }

      (async () => {
        try {
          UI.showLoading("Approving request...");
          const resp = await API.approveRequest(requestId, {
            vault_id: Number(vaultId),
          });
          Logger.log("Request approved successfully:", resp);
          UI.showToast("Request approved successfully", "success");
          APP.loadPayrollRequests();
        } catch (err) {
          Logger.error("Failed to approve request:", err);
          UI.showToast(
            "Failed to approve request: " + err.message,
            "error"
          );
        } finally {
          UI.hideLoading();
        }
      })();

      return;
    }
  });
},

        async backgroundRefreshSection(section) {
            if (section === 'dashboard') {
                try {
                    const [dashboardData, vaultsData] = await Promise.all([
                        API.getDashboard(),
                        API.getVaults()
                    ]);
                    const vaultsGrid = document.getElementById('vaultsGrid');
                    if (vaultsGrid) {
                        vaultsGrid.innerHTML = this.renderDashboardVaultsGrid(vaultsData.data, dashboardData.data.currency || 'EGP');
                    }
                    // تحديث باقي عناصر الداشبورد لو يوجد
                    Logger.log(`Background data refreshed for section: ${section}`);
                } catch (error) {
                    Logger.error('Failed in background refresh for dashboard:', error);
                }
            }
            // دعم أقسام أخرى كما تريد
        },

        async loadExpensesData(force = false, append = false) {
          if (STATE.expenses && !force && !append) {
            // Already have expenses data and no force reload, render cached view
            console.log("HIDE LOADER #1 (cached)");
            STATE.setLoading("expenses", false);

            STATE.expensesLoaded = true;
            document.getElementById("mainContent").innerHTML =
              await this.renderExpenses();
            this.attachSectionEvents("expenses");
            return;
          }

          STATE.setLoading("expenses", true);

          try {
            const page = append ? APP.expensesCurrentPage + 1 : 1;
            const resp = await API.getExpenses({ per_page: 10, page });
            let data = resp.data || [];

            if (append && STATE.expenses) {
              STATE.expenses = STATE.expenses.concat(data);
            } else {
              STATE.expenses = data;
            }

            console.log("HIDE LOADER #2 (after fetch)");
            STATE.setLoading("expenses", false);

            STATE.expensesLoaded = true;
            APP.expensesCurrentPage = page;
            APP.expensesLastPage =
              !resp.pagination ||
              (resp.pagination.total_pages &&
                resp.pagination.total_pages === page);

            STATE.setCache("expenses", STATE.expenses);

            document.getElementById("mainContent").innerHTML =
              await this.renderExpenses();
            this.attachSectionEvents("expenses");
          } catch (err) {
            console.log("HIDE LOADER #3 (error)");
            STATE.setLoading("expenses", false);

            UI.showToast("Unable to load expenses. Please try again.", "error");
          }
        },


    async addVault(vaultDataFromForm) {
      Logger.log("addVault called with raw data:", vaultDataFromForm);

      // Build payload structured for backend
      const userId = STATE.user?.id || null; // current employee id

      const payload = {
        name: vaultDataFromForm.name.trim(),
        payment_method: vaultDataFromForm.payment_method,
        balance: Number(vaultDataFromForm.balance || 0),
        commission_rate: Number(vaultDataFromForm.commission_rate || 0),
        default_warehouse: vaultDataFromForm.default_warehouse?.trim() || "",
        // employees: array of employee ids (here current user only)
        employees: [userId], // backend will json_encode
        is_default: vaultDataFromForm.is_default ? 1 : 0
        // created_at will be set automatically in PHP using current_time('mysql')
      };

      Logger.log("addVault payload to API:", payload);

      try {
        UI.showLoading("Adding vault...");
        const resp = await API.createVault(payload);
        Logger.log("Vault created successfully:", resp);
        UI.showToast("Vault added successfully", "success");

        STATE.clearCache("vaults");
        STATE.clearSectionCache("dashboard");
        Logger.log("Cleared vaults and dashboard caches after creating vault");

        await this.loadSection("vaults", true);
        Logger.log("Vaults section reloaded (forceRefresh)");
      } catch (error) {
        Logger.error("Failed to add vault:", error);
        UI.showToast("Failed to add vault: " + error.message, "error");
      } finally {
        UI.hideLoading();
      }
    },

async transferMoney(transferData) {
  Logger.log("transferMoney called with data:", transferData);
  try {
    UI.showLoading("Transferring money...");
    Logger.log("Sending POST /vaults/transfer request...");
    const resp = await API.transferBetweenVaults(transferData);
    Logger.log("Money transferred successfully:", resp);

    UI.showToast("Money transferred successfully", "success");

    STATE.clearCache("vaults");
    STATE.clearSectionCache("dashboard");
    Logger.log("Vault caches cleared after transfer (vaults, dashboard)");

    await this.loadSection("vaults", true);
    Logger.log("Vaults section reloaded with forceRefresh");
  } catch (error) {
    Logger.error("Transfer failed:", error);
    UI.showToast("Transfer failed: " + error.message, "error");
  } finally {
    UI.hideLoading();
  }
},

showAddVaultModal() {
  Logger.log("showAddVaultModal called");
  const modal = document.getElementById("vaultModal");
  const form = document.getElementById("vaultForm");

  if (!modal || !form) {
    Logger.warn("Vault modal or form not found in DOM");
    return;
  }

  form.reset();
  form.dataset.id = ""; // إنشاء جديد
  Logger.log("Vault form reset and prepared for create");

  modal.classList.remove("hidden");
  Logger.log("Vault modal opened");
},

showTransferMoneyModal() {
  Logger.log("showTransferMoneyModal called");
  const modal = document.getElementById("transferModal");
  const form = document.getElementById("transferForm");

  if (!modal || !form) {
    Logger.warn("Transfer modal or form not found in DOM");
    return;
  }

  form.reset();
  Logger.log("Transfer form reset");

  // ✅ ملء employee_id من STATE.user
  const userId = STATE.user?.id || "";
  const employeeInput = document.getElementById("transferEmployee");
  if (employeeInput) {
    employeeInput.value = userId;
    Logger.log("transferEmployee set to:", userId);
  } else {
    Logger.warn("transferEmployee hidden input not found");
  }

  Logger.log("Fetching vaults for transfer dropdowns...");
  API.getVaults()
    .then((resp) => {
      const vaults = resp.data || [];
      Logger.log("Vaults loaded for transfer:", vaults);

      const fromSelect = document.getElementById("fromVault");
      const toSelect = document.getElementById("toVault");
      if (!fromSelect || !toSelect) {
        Logger.warn("Transfer selects (fromVault / toVault) not found");
        return;
      }

      fromSelect.innerHTML = '<option value="">Select vault</option>';
      toSelect.innerHTML = '<option value="">Select vault</option>';

      vaults.forEach((v) => {
        const option1 = document.createElement("option");
        option1.value = v.id;
        option1.textContent = v.name;
        fromSelect.appendChild(option1);

        const option2 = document.createElement("option");
        option2.value = v.id;
        option2.textContent = v.name;
        toSelect.appendChild(option2);
      });

      Logger.log("Transfer selects populated with vaults");
    })
    .catch((error) => {
      Logger.error("Failed to load vaults for transfer:", error);
    });

  modal.classList.remove("hidden");
  Logger.log("Transfer modal opened");
},

showShrmsLoginModal(onSuccessCallback) {
  Logger.log("showShrmsLoginModal called");

  const modal = document.getElementById("shrmsLoginModal");
  const form = document.getElementById("shrmsLoginForm");
  const phoneInput = document.getElementById("shrmsPhone");
  const passwordInput = document.getElementById("shrmsPassword");

  if (!modal || !form || !phoneInput || !passwordInput) {
    Logger.warn("SHRMS login modal or fields not found");
    return;
  }

  // حفظ callback في APP لاستخدامه بعد login
  this._shrmsLoginSuccessCallback = onSuccessCallback || null;

  form.reset();
  phoneInput.value = STATE.user?.phone || "";

  modal.classList.remove("hidden");
},

async handleShrmsLoginSubmit(e) {
  e.preventDefault();
  Logger.log("handleShrmsLoginSubmit called");

  const form = e.target;
  const phone = form.phone.value;
  const password = form.password.value;

  try {
    UI.showLoading("Logging into HR system...");
    const resp = await API.shrmsLogin(phone, password);
    Logger.log("SHRMS login successful:", resp);

    const token = resp.data?.token || resp.token || null;
    if (!token) {
      throw new Error("No SHRMS token returned from API");
    }

    STATE.setShrmsToken(token);
    UI.showToast("HR login successful", "success");

    // إغلاق المودال
    document.getElementById("shrmsLoginModal")?.classList.add("hidden");

    // إعادة تنفيذ الـ callback (مثلاً showPayrollRequestModal)
    if (typeof this._shrmsLoginSuccessCallback === "function") {
      const cb = this._shrmsLoginSuccessCallback;
      this._shrmsLoginSuccessCallback = null;
      cb();
    }
  } catch (error) {
    Logger.error("SHRMS login failed:", error);
    UI.showToast("HR login failed: " + error.message, "error");
  } finally {
    UI.hideLoading();
  }
},



showAddFundsModal(vaultId, vaultName) {
  Logger.log("showAddFundsModal called for vault:", { vaultId, vaultName });

  const modal = document.getElementById("addFundsModal");
  const form = document.getElementById("addFundsForm");
  const nameInput = document.getElementById("addFundsVaultName");
  const idInput = document.getElementById("addFundsVaultId");
  const employeeInput = document.getElementById("addFundsEmployeeId");

  if (!modal || !form || !nameInput || !idInput || !employeeInput) {
    Logger.warn("Add funds modal or fields not found in DOM");
    return;
  }

  form.reset();

  nameInput.value = vaultName || "";
  idInput.value = vaultId;
  const userId = STATE.user?.id || "";
  employeeInput.value = userId;

  Logger.log("Add funds modal prepared with:", {
    vaultId,
    vaultName,
    employeeId: userId,
  });

  modal.classList.remove("hidden");
  Logger.log("Add funds modal opened");
},

async addFundsToVault(payload) {
  Logger.log("APP.addFundsToVault called with payload:", payload);

  try {
    UI.showLoading("Adding funds...");
    const resp = await API.addFundsToVault(payload);
    Logger.log("Funds added successfully:", resp);
    UI.showToast("Funds added successfully", "success");

    // تحديث الكاش والواجهات
    STATE.clearCache("vaults");
    STATE.clearSectionCache("dashboard");
    Logger.log("Cleared vaults and dashboard caches after add-funds");

    await this.loadSection("vaults", true);
    Logger.log("Vaults section reloaded after add-funds");
  } catch (error) {
    Logger.error("Failed to add funds to vault:", error);
    UI.showToast("Failed to add funds: " + error.message, "error");
  } finally {
    UI.hideLoading();
  }
  
},



        initDashboard() {
          Logger.info("Initializing dashboard");

          const user = STATE.get("user");
          document.getElementById("userName").textContent = user.name;
          document.getElementById("userRole").textContent = user.role;

          this.buildNavigation();
          UI.showPage("dashboardPage");
          this.loadSection("dashboard");
        },

        buildNavigation() {
          const navItems = [
            { id: "dashboard", icon: "fa-tachometer-alt", label: "Dashboard" },
            { id: "expenses", icon: "fa-receipt", label: "Expenses" },
            { id: "vaults", icon: "fa-vault", label: "Vaults" },
            { id: "payroll", icon: "fa-money-bill-wave", label: "Payroll" },
            { id: "loans", icon: "fa-hand-holding-usd", label: "Loans" },
            // { id: "vendors", icon: "fa-truck", label: "Vendors" },
            // { id: "reports", icon: "fa-chart-bar", label: "Reports" },
            // { id: "settings", icon: "fa-cog", label: "Settings" },
          ];

          const nav = document.getElementById("sidebarNav");
          nav.innerHTML = navItems
            .map(
              (item) => `
                    <div class="nav-item">
                        <a href="#" class="nav-link ${
                          item.id === "dashboard" ? "active" : ""
                        }" data-section="${item.id}">
                            <i class="fas ${item.icon}"></i>
                            <span>${item.label}</span>
                        </a>
                    </div>
                `
            )
            .join("");

          // Add click handlers
          nav.querySelectorAll(".nav-link").forEach((link) => {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              const section = link.dataset.section;

              // ✅ Load without forcing refresh (use cache if available)
              this.loadSection(section, false);

              // Update active state
              nav
                .querySelectorAll(".nav-link")
                .forEach((l) => l.classList.remove("active"));
              link.classList.add("active");

              // Close mobile menu
              if (window.innerWidth <= 768) {
                document.getElementById("sidebar").classList.remove("show");
              }
            });
          });
        },

async loadSection(section, forceRefresh = true) {
  Logger.info(`\n===========================================`);
  Logger.info(
    `Starting to load section: ${section} (forceRefresh: ${forceRefresh})`
  );

  if (STATE.isLoading(section)) {
    Logger.warn(
      `Section ${section} is already loading, skipping duplicate load.`
    );
    return;
  }

  // Clear any existing auto-refresh for previous section
  STATE.clearAutoRefresh();
  STATE.set("currentSection", section);
  Logger.info(
    `Set currentSection to '${section}' and cleared previous auto-refresh.`
  );

  const content = document.getElementById("mainContent");
  if (!content) {
    Logger.error("Main content container #mainContent not found.");
    return;
  }

  // Hide any spinners / skeletons from previous section
  document
    .querySelectorAll(".spinner, .skeleton")
    .forEach((el) => el.classList.add("hidden"));
  Logger.info(`Cleared loading indicators in main content area.`);

  // Try cached HTML if not forcing refresh
  if (!forceRefresh) {
    const cachedHtml = STATE.getSectionCache(section);
    Logger.info(
      `Cache lookup for section '${section}': ${
        cachedHtml ? "HIT" : "MISS"
      }`
    );
    if (cachedHtml) {
      Logger.info(`Rendering from cache for section: ${section}`);

      // Explicit cleanup before transition
      content.innerHTML = "";
      document
        .querySelectorAll(".spinner, .skeleton")
        .forEach((el) => el.classList.add("hidden"));

      UI.transitionContent(content, cachedHtml, () => {
        this.attachSectionEvents(section);
        this.startAutoRefresh(section);

         if (section === "dashboard") {
            this.refreshDashboardData();
          } else if (section === "expenses") {
            this.loadExpensesData(true);
          } else if (section === "payroll") {
            this.loadPayrollRequests();
          } else if (section === "loans") {
            this.loadCompanyLoans();
          }
      });

      Logger.info(
        `Exiting loadSection after cache render for '${section}'.`
      );
      return;
    }
  } else {
    STATE.clearSectionCache(section);
    Logger.info(
      `forceRefresh is true - cleared cache for section '${section}'.`
    );
  }

  // Show skeleton while loading
  UI.showSkeleton(content, section === "dashboard" ? "stats" : "default");
  STATE.setLoading(section, true);
  Logger.info(
    `Showed skeleton loader and set loading state for section '${section}'.`
  );

  setTimeout(async () => {
    try {
      Logger.info(
        `Rendering section '${section}' fresh (not from cache)...`
      );
      const html = await this.renderSection(section);
      STATE.setLoading(section, false);

      if (html) {
        Logger.info(
          `Caching freshly rendered HTML for section '${section}' (length: ${html.length} chars)`
        );
        STATE.setSectionCache(section, html);
      } else {
        Logger.warn(
          `Rendered HTML for section '${section}' is empty or undefined.`
        );
      }

      UI.transitionContent(content, html, () => {
        Logger.info(
          `Content transitioned for fresh load of section '${section}'. Attaching events...`
        );
        this.attachSectionEvents(section);
        Logger.info(
          `Events attached for fresh load of section '${section}'. Starting auto-refresh...`
        );
        this.startAutoRefresh(section);

        // 🔹 Post-transition hook for payroll section
          if (section === "payroll") {
            this.loadPayrollRequests();
          } else if (section === "loans") {
            // default tab: company loans
            this.loadCompanyLoans();
          }
      });

      // Special post-render refreshes (dashboard, expenses, etc.)
      if (section === "dashboard") {
        Logger.info(
          `Post-render dashboard: refreshing dashboard data...`
        );
        await this.refreshDashboardData();
      } else if (section === "expenses") {
        Logger.info(
          `Post-render expenses: loading expenses data...`
        );
        await this.loadExpensesData(true);
      }

      Logger.info(`Completed full load for section '${section}'.`);
    } catch (error) {
      STATE.setLoading(section, false);
      Logger.error(`Error rendering section '${section}':`, error);
    }
  }, 100);
},



        async renderSection(section) {
          Logger.info(`Rendering section: ${section}`);

          const content = document.getElementById("mainContent");

          if (!content) {
            Logger.error("mainContent element not found!");
            return;
          }

          try {
            let html = "";

            switch (section) {
              case "dashboard":
                html = await this.renderDashboard();
                break;
              case "expenses":
                html = await this.renderExpenses();
                return ""; // content rendered inside loadExpensesData
                // break;
              case "vaults":
                html = await this.renderVaults();
                break;
              case "payroll":
                html = await this.renderPayroll();
                break;
              case "loans":
                html = await this.renderLoans();
                break;
              case "vendors":
                html = await this.renderVendors();
                break;
              case "reports":
                html = await this.renderReports();
                break;
              case "settings":
                html = await this.renderSettings();
                break;
              default:
                html =
                  '<div class="card"><div class="card-body">Section not found</div></div>';
            }

            if (!html || html.length === 0) {
              throw new Error("No content generated for section");
            }

            Logger.log(
              `HTML generated for ${section}:`,
              html.length,
              "characters"
            );

            STATE.setSectionCache(section, html);

            UI.transitionContent(content, html, () => {
              this.attachSectionEvents(section);
              Logger.info(`Section ${section} fully rendered`);
            });

            return html;
          } catch (error) {
            Logger.error(`Error rendering ${section}:`, error);

            if (content) {
              content.innerHTML = `
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger);"></i>
                                        <h3 style="margin-top: var(--space-4);">Failed to Load</h3>
                                        <p style="color: var(--text-secondary);">${error.message}</p>
                                        <button class="btn btn-primary" onclick="APP.loadSection('${section}', true)">
                                            <i class="fas fa-redo"></i> Retry
                                        </button>
                                    </div>
                                </div>
                            `;
            }
          }
        },

        // Re-attach event listeners after rendering
        attachSectionEvents(section) {
    Logger.log(`Attaching events for: ${section}`);

    // Helper function to safely add event listener once
    const addEventOnce = (selector, event, handler) => {
        document.querySelectorAll(selector).forEach(el => {
            if (!el.dataset.listenerAdded) {
                el.addEventListener(event, handler);
                el.dataset.listenerAdded = "true";
            }
        });
    };

    // Tabs switching example for expenses tabs
    if (section === "dashboard" || section === "expenses") {
        // Remove previously added listener flag when switching sections if needed
        // Or if using delegation, implement once globally.

        if (section === "expenses") {
            const userRole = STATE.user?.role || "admin";
            const isSuperAdmin = userRole === "super_admin";

            if (isSuperAdmin || userRole === "admin") {
                addEventOnce("#addExpenseBtn", "click", () => {
                    APP.showExpenseModal();
                });
            }

            if (isSuperAdmin) {
                addEventOnce('[data-action="edit"]', "click", function () {
                    const id = this.dataset.id;
                    APP.showExpenseModal(id);
                });

                addEventOnce('[data-action="delete"]', "click", async function () {
                    const id = this.dataset.id;
                    if (confirm("Are you sure to delete this expense?")) {
                        UI.showLoading("Deleting expense...");
                        try {
                            await API.request(`/expenses/${id}`, { method: "DELETE" });
                            UI.showToast("Expense deleted successfully", "success");
                            await APP.loadExpensesData(true);
                        } catch (error) {
                            UI.showToast("Delete failed: " + error.message, "error");
                        } finally {
                            UI.hideLoading();
                        }
                    }
                });
            }

            addEventOnce("#loadMoreExpensesBtn", "click", () => {
                if (!STATE.isLoading("load_more_expenses")) {
                    APP.loadExpensesData(false, true);
                }
            });
        }

 
           if (section === "vaults") {
    Logger.log("Attaching events for: vaults (vaults-specific block)");

    const addVaultBtn = document.getElementById("addVaultBtn");
    if (addVaultBtn) {
      Logger.log("Binding click event for addVaultBtn");
      addVaultBtn.addEventListener("click", () => {
        Logger.log("addVaultBtn clicked");
        APP.showAddVaultModal();
      });
    } else {
      Logger.warn("addVaultBtn not found in DOM");
    }

    const transferMoneyBtn = document.getElementById("transferMoneyBtn");
    if (transferMoneyBtn) {
      Logger.log("Binding click event for transferMoneyBtn");
      transferMoneyBtn.addEventListener("click", () => {
        Logger.log("transferMoneyBtn clicked");
        APP.showTransferMoneyModal();
      });
    } else {
      Logger.warn("transferMoneyBtn not found in DOM");
    }
  }
  
if (section === "payroll") {
  Logger.log("Attaching events for: payroll");

        // Load payroll requests list
  Logger.log("Requested payroll requests load from attachSectionEvents");
  APP.loadPayrollRequests();



  // تغيير الخزنة لكل راتب
  document
    .querySelectorAll(".payroll-vault-select")
    .forEach((select) => {
      select.addEventListener("change", () => {
        const salaryId = select.dataset.salaryId;
        const amount = Number(select.dataset.salaryAmount || 0);
        const vaultId = select.value;

        Logger.log("Vault changed for salary:", { salaryId, amount, vaultId });

        const vaultSummary = document.getElementById(
          `vaultSummary-${salaryId}`
        );
        const totalsCell = document.getElementById(
          `payrollTotals-${salaryId}`
        );

        if (!vaultId) {
          if (vaultSummary) vaultSummary.textContent = "";
          if (totalsCell)
            totalsCell.innerHTML =
              '<span style="color:var(--text-secondary);">–</span>';
          return;
        }

        // نستخدم كاش الخزن لحساب العمولة والرصد بدون استدعاء API إضافي
        const cachedVaults = STATE.getCache("vaults")?.data || [];
        const vault = cachedVaults.find(
          (v) => String(v.id) === String(vaultId)
        );
        if (!vault) {
          Logger.warn("Vault not found in cache for id:", vaultId);
          return;
        }

        const balance = Number(vault.balance || 0);
        const commissionRate = Number(vault.commission_rate || 0);
        const commission = (amount * commissionRate) / 100;
        const total = amount + commission;
        const enough = balance >= total;

        if (vaultSummary) {
          vaultSummary.innerHTML = `
            Salary: ${amount.toFixed(2)} EGP<br>
            Commission (${commissionRate}%): ${commission.toFixed(
              2
            )} EGP<br>
            Total: ${total.toFixed(2)} EGP<br>
            Vault balance: <span style="color:${
              enough ? "green" : "red"
            };">${balance.toFixed(2)} EGP</span>
          `;
        }

        if (totalsCell) {
          totalsCell.innerHTML = `
            <span>
              Total: ${total.toFixed(2)} EGP
            </span>
          `;
        }
      });
    });

  //  Pay Salary button
  document
    .querySelectorAll(".payroll-pay-btn")
    .forEach((btn) => {
      btn.addEventListener("click", async () => {
        const salaryId = btn.dataset.salaryId;
        const employeeId = btn.dataset.employeeId;
        const amount = Number(btn.dataset.amount || 0);
        const employeeName = btn.dataset.employeeName || "";
        const select = document.querySelector(
          `.payroll-vault-select[data-salary-id="${salaryId}"]`
        );
        const vaultId = select?.value || "";

        Logger.log("Pay button clicked:", {
          salaryId,
          employeeId,
          vaultId,
          amount,
          employeeName,
        });

        if (!vaultId) {
          UI.showToast("Please select a vault first", "error");
          return;
        }

        await APP.paySalary({
          salary_id: Number(salaryId),
          vault_id: Number(vaultId),
          employee_id: Number(employeeId),
          amount,
        });
      });
    });



    const calcBtn = document.getElementById("calculatePayrollBtn");
    if (calcBtn) {
      calcBtn.addEventListener("click", async () => {
        Logger.log("Calculate payroll button clicked");
        // TODO: يمكن لاحقاً إضافة اختيار شهر؛ الآن نفترض current month
        try {
          UI.showLoading("Calculating payroll...");
          const resp = await API.calculatePayroll({ /* month, filters ... */ });
          Logger.log("Payroll calculated:", resp);
          UI.showToast("Payroll calculated successfully", "success");
          STATE.clearSectionCache("payroll");
          await APP.loadSection("payroll", true);
        } catch (error) {
          Logger.error("Failed to calculate payroll:", error);
          UI.showToast("Failed to calculate payroll: " + error.message, "error");
        } finally {
          UI.hideLoading();
        }
      });
    }


    
  const createReqBtn = document.getElementById("createRequestBtn");
  if (createReqBtn) {
    createReqBtn.addEventListener("click", () => {
      APP.showPayrollRequestModal();
    });
  }


}
if (section === "loans") {
  Logger.log("Attaching events for: loans");

  // Tabs switching
  const tabButtons = document.querySelectorAll(".loans-tab-btn");
  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.loansTab;

      tabButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      if (tab === "company") {
        APP.loadCompanyLoans();
      } else if (tab === "employee") {
        APP.loadEmployeeLoans();
      } else if (tab === "payments") {
        APP.loadLoanPayments?.(); // يمكن إضافتها لاحقاً
      }
    });
  });

  // Create company loan button
  const createCompanyLoanBtn = document.getElementById("createCompanyLoanBtn");
  if (createCompanyLoanBtn) {
    createCompanyLoanBtn.addEventListener("click", () => {
      APP.showCreateCompanyLoanModal?.();
    });
  }

  // Create employee loan button
  const createEmployeeLoanBtn = document.getElementById(
    "createEmployeeLoanBtn"
  );
  if (createEmployeeLoanBtn) {
    createEmployeeLoanBtn.addEventListener("click", () => {
      APP.showCreateEmployeeLoanModal?.();
    });
  }
}




        // For tab-btn switching (delegation might be better globally)
        addEventOnce('.tab-btn', "click", function (e) {
            const btn = e.currentTarget;
            const tab = btn.dataset.tab;

            document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));
            document.querySelector(`[data-content="${tab}"]`)?.classList.add("active");

            Logger.log(`Switched to expenses tab: ${tab}`);
        });
    }
},


        // Auto-refresh system
        startAutoRefresh(section) {
    // Clear previous auto-refresh interval for this section if exists
    STATE.clearAutoRefresh(`section_${section}`);

    // Enable auto-refresh only if enabled in configuration
    if (!CONFIG.AUTO_REFRESH.enabled) {
        return;
    }

    // Define intervals per section as needed
    const intervals = {
        dashboard: CONFIG.AUTO_REFRESH.dashboard,
        expenses: 60000, // e.g., refresh expenses every 60 seconds
        // Add other sections if needed, e.g.,
        // vaults: 120000,
    };

    if (intervals[section]) {
        STATE.setAutoRefresh(
            `section_${section}`,
            () => {
                Logger.log(`Auto-refreshing section: ${section}`);
                if (section === 'dashboard') {
                    this.refreshDashboardData();
                } else if (section === 'expenses') {
                    this.loadExpensesData(true);  // force refresh expenses data
                }
                // Add other conditional refresh functions for other sections here
            },
            intervals[section]
        );
        Logger.log(`Auto-refresh started for: ${section}`);
    }
},


        // ✅ Refresh data without full reload
        async refreshDashboardData() {
            Logger.log('Refreshing dashboard and vaults data...');
            try {
                // Fetch fresh data
                const [dashboardData, vaultsResponse] = await Promise.all([
                    API.getDashboard(),
                    API.getVaults(),
                ]);

                // Update only the stats, not the whole page
                const vaults = vaultsResponse.data;
                const dashboard = dashboardData.data;
                const currency = dashboard.currency || "EGP";

                // Update vaults grid
                const vaultsGrid = document.getElementById("vaultsGrid");
                if (vaultsGrid) {
                    vaultsGrid.innerHTML = this.renderDashboardVaultsGrid(vaults, currency);
                    Logger.log('Vaults updated:', vaults);  // تتبع في الكونسول
                }

                // Update sales stats
                const salesStats = document.getElementById("salesStats");
                if (salesStats) {
                    salesStats.innerHTML = this.renderSalesStats(dashboard, currency);
                    Logger.log('Sales stats updated:', dashboard);  // تتبع في الكونسول
                }

                Logger.log("Dashboard data refreshed silently");
            } catch (error) {
                Logger.error("Failed to refresh dashboard:", error);
            }
        },


        // ============================================
        // DASHBOARD RENDERING
        // ============================================
        async renderDashboard() {
          Logger.info("Rendering dashboard");

          try {
            // ✅ Step 1: Fetch basic data first (fast response)
            const [dashboardData, vaultsResponse] = await Promise.all([
              API.getDashboard(),
              API.getVaults(),
            ]);

            const dashboard = dashboardData.data;
            const vaults = vaultsResponse.data;
            const currency = dashboard.currency || "EGP";

            Logger.log("Basic dashboard data loaded");

            // ✅ Step 2: Return partial content with specific IDs
            const partialHtml = `
                        <!-- Vaults Overview -->
                        <div class="section-header">
                            <h2>Vaults Overview</h2>
                        </div>
                        <div class="stats-grid" id="vaultsGrid">
                            ${this.renderDashboardVaultsGrid(vaults, currency)}
                        </div>
                        
                        <!-- Sales Statistics -->
                        <div class="section-header">
                            <h2>Sales Statistics</h2>
                        </div>
                        <div class="stats-grid" id="salesStats">
                            ${this.renderSalesStats(dashboard, currency)}
                        </div>
                        
                        <!-- Expenses Placeholder -->
                        <div id="expensesSection">
                            <div class="section-header">
                                <h2>Expenses Breakdown</h2>
                            </div>
                            <div class="skeleton skeleton-card" style="height: 300px; margin-bottom: var(--space-8);"></div>
                        </div>
                        
                        <!-- Cashflow Placeholder -->
                        <div id="cashflowSection">
                            <div class="section-header">
                                <h2>Recent Transactions</h2>
                            </div>
                            <div class="skeleton skeleton-card" style="height: 400px;"></div>
                        </div>
                    `;

            // ✅ Step 3: Load remaining data in background
            setTimeout(async () => {
              try {
                const [cashflowResponse, categoriesResponse] =
                  await Promise.all([
                    API.getCashflow({ per_page: 15 }),
                    API.getCategories(),
                  ]);

                const cashflow = cashflowResponse.data;
                const categories = categoriesResponse.data;

                Logger.log("Additional dashboard data loaded");

                // Calculate expenses (this is slow)
                const expensesByCategory =
                  await this.calculateExpensesByCategory(categories);

                // ✅ Step 4: Update expenses section by ID
                const expensesSection =
                  document.getElementById("expensesSection");
                if (expensesSection) {
                  expensesSection.innerHTML = `
                                    <div class="section-header">
                                        <h2>Expenses Breakdown</h2>
                                    </div>
                                    <div class="expenses-breakdown progressive-fade-in">
                                        ${this.renderExpensesBreakdown(
                                          expensesByCategory,
                                          currency
                                        )}
                                    </div>
                                `;

                  // Re-attach tab events
                  this.attachSectionEvents("dashboard");
                  Logger.log("Expenses section updated");
                }

                // ✅ Step 5: Update cashflow section by ID
                const cashflowSection =
                  document.getElementById("cashflowSection");
                if (cashflowSection) {
                  cashflowSection.innerHTML = `
                                    <div class="section-header">
                                        <h2>Recent Transactions</h2>
                                    </div>
                                    <div class="card progressive-fade-in">
                                        <div class="card-body">
                                            ${this.renderCashflowTable(
                                              cashflow,
                                              currency
                                            )}
                                        </div>
                                    </div>
                                `;
                  Logger.log("Cashflow section updated");
                }

                Logger.info("Dashboard fully loaded");

                // ✅ Update cache with full content
                const fullHtml =
                  document.getElementById("mainContent").innerHTML;
                STATE.setSectionCache("dashboard", fullHtml);
              } catch (error) {
                Logger.error(
                  "Failed to load additional dashboard data:",
                  error
                );

                // ✅ Show error in skeletons
                const expensesSection =
                  document.getElementById("expensesSection");
                if (expensesSection) {
                  expensesSection.innerHTML = `
                                    <div class="section-header">
                                        <h2>Expenses Breakdown</h2>
                                    </div>
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <p style="color: var(--danger);">Failed to load expenses data</p>
                                        </div>
                                    </div>
                                `;
                }

                const cashflowSection =
                  document.getElementById("cashflowSection");
                if (cashflowSection) {
                  cashflowSection.innerHTML = `
                                    <div class="section-header">
                                        <h2>Recent Transactions</h2>
                                    </div>
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <p style="color: var(--danger);">Failed to load cashflow data</p>
                                        </div>
                                    </div>
                                `;
                }
              }
            }, 100);

            Logger.info("Dashboard partial render complete");

            // Return partial HTML immediately
            return partialHtml;
          } catch (error) {
            Logger.error("Dashboard rendering failed:", error);
            throw error;
          }
        },

    async renderExpenses() {
    const userRole = STATE.user?.role || "admin";
    const isSuperAdmin = userRole === "super_admin";

    
    if (!STATE.expenses) {
        try {
            const resp = await API.getExpenses({ per_page: 20, page: 1 });
            STATE.expenses = resp.data || [];
            APP.expensesCurrentPage = 1;
            APP.expensesLastPage = !resp.pagination || 
                (resp.pagination.total_pages && resp.pagination.total_pages === 1);
            STATE.setCache("expenses", STATE.expenses);
        } catch (error) {
            Logger.error("Failed to load expenses:", error);
            return `
                <div class="section-header"><h2>Expenses Management</h2></div>
                <div class="card">
                    <div class="card-body text-center" style="padding:2rem">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--danger);"></i>
                        <p style="margin-top: 1rem;">Failed to load expenses</p>
                    </div>
                </div>
            `;
        }
    }

    const expenses = STATE.expenses || [];
    
    if (!expenses || expenses.length === 0) {
        const addBtn = (isSuperAdmin || userRole === "admin")
            ? `<div class="expea-header-btns" style="text-align:right;margin-bottom:1.5rem;">
                    <button id="addExpenseBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
               </div>`
            : "";

        return `
            <div class="section-header"><h2>Expenses Management</h2></div>
            ${addBtn}
            <div class="card">
                <div class="card-body text-center" style="padding:2rem">
                    No expenses found.
                </div>
            </div>
        `;
    }

    const rows = expenses
        .map((expense) => `
            <tr>
                
                <td><span style="color:var(--text-tertiary);">${expense.employee_name || ""}</span></td>
                <td><span style="color:var(--text-tertiary);">${expense.description || ""}</span></td>
                <td><span style="font-weight:700; color:var(--primary);">${Number(expense.amount).toLocaleString()} EGP</span></td>
                <td>${expense.category_name || "Uncategorized"}</td>
                <td><span style="color:var(--text-secondary);">${expense.created_at}</span></td>
                <td>
                    ${isSuperAdmin
                        ? `<button class="btn btn-secondary btn-sm" data-id="${expense.id}" data-action="edit" style="margin-right:2px;">Edit</button>
                           <button class="btn btn-danger btn-sm" data-id="${expense.id}" data-action="delete">Delete</button>`
                        : ""}
                </td>
            </tr>
        `)
        .join("");

    const addBtn = (isSuperAdmin || userRole === "admin")
        ? `<div class="expea-header-btns" style="text-align:right;margin-bottom:1.5rem;">
                <button id="addExpenseBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Expense
                </button>
           </div>`
        : "";

    const loadMoreBtn = !APP.expensesLastPage
        ? `<div style="text-align:center; margin:1.5rem 0;">
                <button id="loadMoreExpensesBtn" class="btn btn-secondary" style="min-width:160px;">
                    Load More
                </button>
           </div>`
        : "";

    return `
        <div class="section-header"><h2>Expenses Management</h2></div>
        ${addBtn}
        <div class="table-container" id="expensesTableContainer" style="min-height:320px;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
        ${loadMoreBtn}
    `;
},


            async renderVaults() {
  try {
    const response = await API.getVaults();
    const vaults = response.data || [];

    if (!vaults.length) {
      return `
        <div class="section-header"><h2>Vaults</h2></div>
        <div class="card"><div class="card-body text-center">No vaults found.</div></div>
      `;
    }


    const currency = "EGP";
    return `
          <div class="section-header">
      <h2>Vaults</h2>
      <div style="text-align:center;margin:17px auto;">
        <button id="addVaultBtn" class="btn btn-primary" style="margin-right:8px;">
          <i class="fas fa-plus"></i> Add Vault
        </button>
        <button id="transferMoneyBtn" class="btn btn-secondary">
          <i class="fas fa-exchange-alt"></i> Transfer Money
        </button>
      </div>
    </div>
    <div class="stats-grid" id="vaultsGrid">
      ${this.renderVaultsManagementGrid(vaults, currency)}
    </div>
    `;
  } catch (error) {
    Logger.error("Failed to load vaults:", error);
    return `
      <div class="card">
        <div class="card-body text-center">
          Failed to load vaults data.
        </div>
      </div>
    `;
  }
},

renderVaultsManagementGrid(vaults, currency) {
  if (!vaults || vaults.length === 0) {
    return `
      <div class="card">
        <div class="card-body text-center">No vaults found.</div>
      </div>
    `;
  }

  const userRole = STATE.user?.role || "admin";
  const isSuperAdmin = userRole === "super_admin";

  return vaults.map((vault) => `
    <div class="stat-card vault-card">
      <div class="stat-header">
        <span class="stat-label">${vault.name}</span>
        ${vault.is_default ? '<span class="badge badge-primary" style="margin-left:6px;">Default</span>' : ""}
      </div>

      <div class="stat-value">
        ${Number(vault.balance).toLocaleString()} ${currency}
      </div>

      <div class="stat-footer">
        <span class="badge badge-secondary">${vault.payment_method}</span>
        ${vault.commission_rate > 0 ? `<span class="badge badge-warning">${vault.commission_rate}%</span>` : ""}
      </div>

      ${
        isSuperAdmin
          ? `
            <div class="vault-actions" style="margin-top: 20px;text-align: center;display: flex;justify-content:space-between;">
              <button
                class="btn btn-sm btn-danger"
                data-action="delete-vault"
                data-id="${vault.id}"
                style="padding: 5px; font-size: 12;"
              >
                Delete
              </button>
              <button
                class="btn btn-sm btn-primary"
                data-action="add-funds"
                data-id="${vault.id}"
                data-name="${vault.name}"
                style="margin-left:8px;"
              >
                Add Funds
              </button>
            </div>
          `
          : ""
      }
    </div>
  `).join("");
},


          renderDashboardVaultsGrid(vaults, currency) {
            if (!vaults || vaults.length === 0) {
              return `
                <div class="card">
                  <div class="card-body text-center">No vaults found.</div>
                </div>
              `;
            }

            return vaults.map((vault) => `
              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-label">${vault.name}</span>
                  ${vault.is_default ? '<span class="badge badge-primary">Default</span>' : ""}
                </div>
                <div class="stat-value">
                  ${Number(vault.balance).toLocaleString()} ${currency}
                </div>
                <div class="stat-footer">
                  <span class="badge badge-secondary">${vault.payment_method}</span>
                </div>
              </div>
            `).join("");
          },

async loadCompanyLoans() {
  Logger.log("loadCompanyLoans called");

  try {
    const resp = await API.getCompanyLoans({ per_page: 50 });
    const loans = resp.data || [];
    const pagination = resp.pagination || {};
    Logger.log("Company loans loaded:", loans.length);

    const stats = {
      total: loans.length,
      active: 0,
      completed: 0,
      defaulted: 0,
      totalAmount: 0,
      remainingAmount: 0,
    };

    loans.forEach((loan) => {
      const status = loan.status || "active";
      const total = Number(loan.loan_amount || 0);
      const remaining = Number(loan.remaining_balance || 0);

      stats.totalAmount += total;
      stats.remainingAmount += remaining;

      if (status === "completed") stats.completed += 1;
      else if (status === "defaulted") stats.defaulted += 1;
      else stats.active += 1;
    });

    this._companyLoans = loans;
    this._companyLoansStats = stats;

    this.renderCompanyLoansTable(loans, stats, pagination);
  } catch (error) {
    Logger.error("Failed to load company loans:", error);
    UI.showToast("Failed to load company loans: " + error.message, "error");
  }
},

async loadEmployeeLoans() {
  Logger.log("loadEmployeeLoans called");

  try {
    const resp = await API.getEmployeeLoans({ per_page: 50 });
    const loans = resp.data || [];
    const pagination = resp.pagination || {};
    Logger.log("Employee loans loaded:", loans.length);

    const stats = {
      total: loans.length,
      active: 0,
      completed: 0,
      suspended: 0,
      totalAmount: 0,
      remainingAmount: 0,
    };

    loans.forEach((loan) => {
      const status = loan.status || "active";
      const total = Number(loan.loan_amount || 0);
      const remaining = Number(loan.remaining_balance || 0);

      stats.totalAmount += total;
      stats.remainingAmount += remaining;

      if (status === "completed") stats.completed += 1;
      else if (status === "suspended") stats.suspended += 1;
      else stats.active += 1;
    });

    this._employeeLoans = loans;
    this._employeeLoansStats = stats;

    this.renderEmployeeLoansTable(loans, stats, pagination);
  } catch (error) {
    Logger.error("Failed to load employee loans:", error);
    UI.showToast("Failed to load employee loans: " + error.message, "error");
  }
},

renderCompanyLoansTable(loans, stats, pagination) {
  const container = document.getElementById("loansListContainer");
  const statsContainer = document.getElementById("loansStats");
  if (!container) {
    Logger.warn("loansListContainer not found");
    return;
  }
  const currency = "EGP";

  if (statsContainer) {
  statsContainer.innerHTML = `
    <div class="card stats-card mb-3">
      <div class="card-body">
        <div class="row stats-row text-center">
          <div class="col stats-col">
            <div class="stats-label">Total Loans</div>
            <div class="stats-value">${stats.total}</div>
          </div>
          <div class="col stats-col">
            <div class="stats-label">Active</div>
            <div class="stats-value">${stats.active}</div>
          </div>
          <div class="col stats-col">
            <div class="stats-label">Completed</div>
            <div class="stats-value">${stats.completed}</div>
          </div>
          <div class="col stats-col">
            <div class="stats-label">Defaulted</div>
            <div class="stats-value">${stats.defaulted}</div>
          </div>
          <div class="col stats-col">
            <div class="stats-label">Total Amount</div>
            <div class="stats-value">${stats.totalAmount.toLocaleString()} EGP</div>
          </div>
          <div class="col stats-col">
            <div class="stats-label">Remaining</div>
            <div class="stats-value">${stats.remainingAmount.toLocaleString()} EGP</div>
          </div>
        </div>
      </div>
    </div>
  `;
}


  const rowsHtml = loans
    .map((loan) => {
      const status = loan.status || "active";
      const total = Number(loan.loan_amount || 0);
      const remaining = Number(loan.remaining_balance || 0);
      const installment = Number(loan.installment_amount || 0);

      const statusClass =
        status === "completed"
          ? "success"
          : status === "defaulted"
          ? "danger"
          : "info";

      return `
        <tr data-loan-id="${loan.id}">
          <td>${loan.lender_name}</td>
          <td>${loan.receiver_name || loan.receiver_employee_id}</td>
          <td>${total.toLocaleString()} ${currency}</td>
          <td>${installment ? installment.toLocaleString() + " " + currency : "-"}</td>
          <td>${remaining.toLocaleString()} ${currency}</td>
          <td>${loan.loan_date || "-"}</td>
          <td>${loan.due_date || "-"}</td>
          <td>
            <span class="badge badge-${statusClass}">${status}</span>
          </td>
        </tr>
      `;
    })
    .join("");

  container.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Company Loans</h5>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Lender</th>
                <th>Receiver (Employee)</th>
                <th>Amount</th>
                <th>Installment</th>
                <th>Remaining</th>
                <th>Loan Date</th>
                <th>Due Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${
                rowsHtml ||
                `<tr><td colspan="8" class="text-center">No company loans found</td></tr>`
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
},

renderEmployeeLoansTable(loans, stats, pagination) {
  const container = document.getElementById("loansListContainer");
  const statsContainer = document.getElementById("loansStats");
  if (!container) {
    Logger.warn("loansListContainer not found");
    return;
  }
  const currency = "EGP";

  if (statsContainer) {
    statsContainer.innerHTML = `
      <div class="card mb-3">
        <div class="card-body">
          <div class="row text-center">
            <div class="col">
              <div class="small text-muted">Total Loans</div>
              <div class="h5">${stats.total}</div>
            </div>
            <div class="col">
              <div class="small text-muted">Active</div>
              <div class="h5">${stats.active}</div>
            </div>
            <div class="col">
              <div class="small text-muted">Completed</div>
              <div class="h5">${stats.completed}</div>
            </div>
            <div class="col">
              <div class="small text-muted">Suspended</div>
              <div class="h5">${stats.suspended}</div>
            </div>
            <div class="col">
              <div class="small text-muted">Total Amount</div>
              <div class="h5">${stats.totalAmount.toLocaleString()} ${currency}</div>
            </div>
            <div class="col">
              <div class="small text-muted">Remaining</div>
              <div class="h5">${stats.remainingAmount.toLocaleString()} ${currency}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  const rowsHtml = loans
    .map((loan) => {
      const status = loan.status || "active";
      const total = Number(loan.loan_amount || 0);
      const remaining = Number(loan.remaining_balance || 0);
      const installment = Number(loan.installment_amount || 0);

      const statusClass =
        status === "completed"
          ? "success"
          : status === "suspended"
          ? "warning"
          : "info";

      return `
        <tr data-loan-id="${loan.id}">
          <td>${loan.employee_name || loan.employee_id}</td>
          <td>${loan.employee_salary ? Number(loan.employee_salary).toLocaleString() + " " + currency : "-"}</td>
          <td>${total.toLocaleString()} ${currency}</td>
          <td>${installment ? installment.toLocaleString() + " " + currency : "-"}</td>
          <td>${remaining.toLocaleString()} ${currency}</td>
          <td>${loan.loan_date || "-"}</td>
          <td>${loan.due_date || "-"}</td>
          <td>
            <span class="badge badge-${statusClass}">${status}</span>
          </td>
        </tr>
      `;
    })
    .join("");

  container.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Employee Loans</h5>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Salary</th>
                <th>Amount</th>
                <th>Installment</th>
                <th>Remaining</th>
                <th>Loan Date</th>
                <th>Due Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${
                rowsHtml ||
                `<tr><td colspan="8" class="text-center">No employee loans found</td></tr>`
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
},

          

async deleteVault(vaultId) {
  Logger.log("deleteVault called for id:", vaultId);
  if (!vaultId) {
    Logger.warn("deleteVault called with empty id");
    return;
  }

  const confirmed = confirm("Are you sure you want to delete this vault?");
  if (!confirmed) {
    Logger.log("deleteVault cancelled by user");
    return;
  }

  try {
    UI.showLoading("Deleting vault...");
    Logger.log("Sending DELETE /vaults/" + vaultId);
    const resp = await API.deleteVault(vaultId);
    Logger.log("Vault deleted successfully:", resp);
    UI.showToast("Vault deleted successfully", "success");

    STATE.clearCache("vaults");
    STATE.clearSectionCache("dashboard");
    Logger.log("Cleared vaults and dashboard caches after delete");

    await this.loadSection("vaults", true);
    Logger.log("Vaults section reloaded after delete");
  } catch (error) {
    Logger.error("Failed to delete vault:", error);
    UI.showToast("Failed to delete vault: " + error.message, "error");
  } finally {
    UI.hideLoading();
  }

  

},




  async renderPayroll() {
  Logger.info("Rendering payroll section");

  try {
    const [payrollResp, vaultsResp] = await Promise.all([
      API.getPayroll(),
      API.getVaults(),
    ]);

    const salaries = payrollResp.data || [];
    const vaults = vaultsResp.data || [];
    const currency = "EGP";

    if (!salaries.length) {
      return `
        <div class="section-header"><h2>Payroll Management</h2></div>
        <div class="card">
          <div class="card-body text-center" style="padding:2rem;">
            No payroll data available.
            <br><br>
            <button id="calculatePayrollBtn" class="btn btn-primary">
              <i class="fas fa-calculator"></i> Calculate Payroll
            </button>
          </div>
        </div>
      `;
    }

    const vaultOptions = vaults
      .map(
        (v) => `
          <option value="${v.id}">
            ${v.name} (${v.payment_method}) - ${Number(v.balance).toLocaleString()} ${currency}
          </option>
        `
      )
      .join("");

    const rows = salaries
      .map((row) => {
        const finalSalary = Number(row.final_salary || row.salary || 0);
        const status = row.status || "pending";
        const isPaid = status === "paid";

        return `
          <tr data-salary-id="${row.id}">
            <td>${row.name || "Unknown"}</td>
            <td>${row.month || row.period || "-"}</td>
            <td>${finalSalary.toLocaleString()} ${currency}</td>
            <td>
              <span class="badge badge-${isPaid ? "success" : "warning"}">
                ${isPaid ? "Paid" : "Pending"}
              </span>
            </td>
            <td>
              <select
                class="form-select payroll-vault-select"
                data-salary-id="${row.id}"
                data-salary-amount="${finalSalary}"
                ${isPaid ? "disabled" : ""}
              >
                <option value="">Select vault</option>
                ${vaultOptions}
              </select>
              <div class="payroll-vault-summary" id="vaultSummary-${row.id}" style="margin-top:4px; font-size:0.85rem; color:var(--text-secondary);"></div>
            </td>
            <td id="payrollTotals-${row.id}">
              <span style="color:var(--text-secondary);">–</span>
            </td>
            <td>
              <button
                class="btn btn-sm btn-primary payroll-pay-btn"
                data-salary-id="${row.id}"
                data-employee-id="${row.employee_id}"
                data-employee-name="${row.employee_name || row.employee?.name || ""}"
                data-amount="${finalSalary}"
                ${isPaid ? "disabled" : ""}
              >
                Pay Salary
              </button>
            </td>
          </tr>
        `;
      })
      .join("");

    return `
      <div class="section-header">
        <h2>Payroll Management</h2>
        <div style="text-align:right;">
          <button id="createRequestBtn" class="btn btn-secondary">
            <i class="fas fa-plus"></i> New Request
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Month</th>
                  <th>Salary</th>
                  <th>Status</th>
                  <th>Vault</th>
                  <th>Totals</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      </div>

        <!-- Requests block -->
        <div id="payrollRequestsContainer" style="margin-top: 1.5rem;"></div>
    `;
  } catch (error) {
    Logger.error("Failed to render payroll:", error);
    return `
      <div class="card">
        <div class="card-body text-center" style="padding:2rem;">
          Failed to load payroll data.
        </div>
      </div>
    `;
  }
},


showPayrollRequestModal() {
  Logger.log("showPayrollRequestModal called");

  const modal = document.getElementById("payrollRequestModal");
  const form = document.getElementById("payrollRequestForm");
  const monthInput = document.getElementById("requestMonth");
  const approveNowCheckbox = document.getElementById("requestApproveNow");
  const vaultSelect = document.getElementById("requestVault");
  const vaultGroup = document.getElementById("requestVaultGroup");

  if (!modal || !form) {
    Logger.warn("Payroll request modal not found");
    return;
  }

  form.reset();

  // ضبط الشهر الحالي افتراضياً (YYYY-MM)
  if (monthInput) {
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7); // مثال: 2025-11
    monthInput.value = currentMonth;
    Logger.log("Default request month set to:", currentMonth);
  }

  // تأكد أن checkbox مفعل افتراضياً
  if (approveNowCheckbox) {
    approveNowCheckbox.checked = true;
  }

  // عرض أو إخفاء مجموعة الخزنة حسب checkbox
  const syncVaultVisibility = () => {
    const approveNow = approveNowCheckbox?.checked;
    Logger.log("approve_now changed:", approveNow);
    if (approveNow && vaultGroup) {
      vaultGroup.style.display = "";
    } else if (vaultGroup) {
      vaultGroup.style.display = "none";
      if (vaultSelect) vaultSelect.value = "";
    }
  };
  syncVaultVisibility();
  if (approveNowCheckbox && !approveNowCheckbox._ffa_bound) {
    approveNowCheckbox.addEventListener("change", syncVaultVisibility);
    approveNowCheckbox._ffa_bound = true;
  }

  const loadEmployees = async () => {
    try {
      Logger.log("Loading employees from SHRMS for requests...");
      const resp = await API.request("/employees", {
        baseUrl: CONFIG.SHRMS_API_BASE,
      });
      const employees = resp.data || [];
      const select = document.getElementById("requestEmployee");
      if (!select) {
        Logger.warn("requestEmployee select not found while loading employees");
        return;
      }

      Logger.log("Employees loaded for requests:", employees.length);

      select.innerHTML = '<option value="">Select employee</option>';
      employees.forEach((emp) => {
        const opt = document.createElement("option");
        opt.value = emp.id;
        opt.textContent = emp.name;
        select.appendChild(opt);
      });
    } catch (err) {
      Logger.error("Failed to load employees for requests:", err);
      UI.showToast(
        "Failed to load employees from HR system: " + err.message,
        "error"
      );
    }
  };


const loadVaultsForRequests = async () => {
  try {
    let cachedVaults = STATE.getCache("vaults");
    Logger.log("loadVaultsForRequests - cached vaults:", cachedVaults);

    // لو الكاش غير موجود → نعمل طلب للخزن ونحدث الكاش
    if (!cachedVaults) {
      Logger.log(
        "No cached vaults found when opening request modal - fetching vaults..."
      );

      try {
        // API.getVaults نفسها بتتعامل مع الكاش وتعمل STATE.setCache("vaults", resp)
        const resp = await API.getVaults();
        cachedVaults = resp;
        Logger.log(
          "Vaults fetched on demand for request modal:",
          resp?.data?.length || 0
        );
      } catch (fetchErr) {
        Logger.error("Failed to fetch vaults for requests:", fetchErr);
        // لو فشل الطلب، نخرج بدون كسر المودال
        return;
      }
    }

    const vaults = cachedVaults?.data || [];

    if (!vaultSelect) {
      Logger.warn("requestVault select not found while loading vaults");
      return;
    }

    vaultSelect.innerHTML = '<option value="">Select vault</option>';

    vaults.forEach((v) => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = `${v.name} (${v.payment_method}) - ${Number(
        v.balance
      ).toLocaleString()} EGP`;
      vaultSelect.appendChild(opt);
    });

    Logger.log("Vault options populated for requests:", vaults.length);
  } catch (err) {
    Logger.error("Failed to load vaults for requests:", err);
  }
};

// تعبئة الخزن (من الكاش أو من API عند الحاجة)
loadVaultsForRequests();

modal.classList.remove("hidden");


},



  async submitPayrollRequest(payload, options = {}) {
  Logger.log("submitPayrollRequest called with:", payload, options);

  const approveNow = options.approveNow || false;
  const vaultId = options.vaultId ? Number(options.vaultId) : 0;

  try {
    UI.showLoading("Submitting request...");

    // 1) إنشاء الطلب في SHRMS
    const resp = await API.createRequest(payload);
    Logger.log("Payroll request created:", resp);

    const requestId = resp.data?.id || resp.data?.request_id || null;

    if (!requestId) {
      throw new Error("Request created but no ID returned from SHRMS");
    }

    UI.showToast("Request created successfully", "success");

    // 2) الموافقة الفورية (اختياري)
    if (approveNow) {
      Logger.log("Auto-approving request:", {
        requestId,
        vaultId,
      });

      try {
        const approveResp = await API.approveRequest(requestId, {
          vault_id: vaultId,
        });
        Logger.log("Request approved successfully:", approveResp);
        UI.showToast("Request approved and paid successfully", "success");
      } catch (approveErr) {
        Logger.error("Failed to approve request:", approveErr);
        UI.showToast(
          "Request created but approval failed: " + approveErr.message,
          "error"
        );
      }
    }

    // TODO: ممكن تضيف هنا إعادة تحميل بيانات payroll/requests لو حابب
  } catch (error) {
    Logger.error("Failed to create payroll request:", error);
    UI.showToast("Failed to create request: " + error.message, "error");
  } finally {
    UI.hideLoading();
  }
},



async loadPayrollRequests() {
  Logger.log("loadPayrollRequests called");

  try {
    UI.showInlineLoader?.("payrollRequests"); // لو عندك util لعرض loader داخل بلوك معين

    const resp = await API.getRequests({ per_page: 50 }); // عدّل params لو عندك pagination
    const requests = resp.data || [];

    Logger.log("Payroll requests loaded:", requests.length);

    // احصائيات سريعة
    const stats = {
      total: requests.length,
      pending: 0,
      approved: 0,
      rejected: 0,
      byType: {
        advance: 0,
        bonus: 0,
        deduction: 0,
      },
      totalAmount: 0,
    };

    requests.forEach((req) => {
      const status = req.status || "pending";
      const type = req.type || "advance";
      const amount = Number(req.amount || 0);

      stats.totalAmount += amount;
      if (stats.byType[type] != null) {
        stats.byType[type] += 1;
      }

      if (status === "approved") stats.approved += 1;
      else if (status === "rejected") stats.rejected += 1;
      else stats.pending += 1;
    });

    // خزن في STATE أو على APP
    this._payrollRequests = requests;
    this._payrollRequestStats = stats;

    // حدّث الـ DOM
    this.renderPayrollRequestsTable(requests, stats);
  } catch (error) {
    Logger.error("Failed to load payroll requests:", error);
    UI.showToast("Failed to load payroll requests: " + error.message, "error");
  } finally {
    UI.hideInlineLoader?.("payrollRequests");
  }
},

renderPayrollRequestsTable(requests, stats) {
  const container = document.getElementById("payrollRequestsContainer");
  if (!container) {
    Logger.warn("payrollRequestsContainer not found");
    return;
  }

  const currency = "EGP";

  const statsHtml = `
    <div class="card mb-3">
      <div class="card-body">
        <div class="row text-center">
          <div class="col">
            <div class="small text-muted">Total Requests</div>
            <div class="h5">${stats.total}</div>
          </div>
          <div class="col">
            <div class="small text-muted">Pending</div>
            <div class="h5">${stats.pending}</div>
          </div>
          <div class="col">
            <div class="small text-muted">Approved</div>
            <div class="h5">${stats.approved}</div>
          </div>
          <div class="col">
            <div class="small text-muted">Rejected</div>
            <div class="h5">${stats.rejected}</div>
          </div>
          <div class="col">
            <div class="small text-muted">Total Amount</div>
            <div class="h5">${stats.totalAmount.toLocaleString()} ${currency}</div>
          </div>
        </div>
      </div>
    </div>
  `;

  const rowsHtml = requests
    .map((req) => {
      const status = req.status || "pending";
      const isApproved = status === "approved";
      const isRejected = status === "rejected";
      const isPending = !isApproved && !isRejected;
      const amount = Number(req.amount || 0);

      const statusBadgeClass =
        status === "approved"
          ? "success"
          : status === "rejected"
          ? "danger"
          : "warning";

      return `
        <tr data-request-id="${req.id}">
          <td>${req.id}</td>
          <td>${req.employee_name || req.employee_id}</td>
          <td>${req.type}</td>
          <td>${amount.toLocaleString()} ${currency}</td>
          <td>${req.month || "-"}</td>
          <td>${req.reason || "-"}</td>
          <td>
            <span class="badge badge-${statusBadgeClass}">
              ${status}
            </span>
          </td>
          <td>
            ${
              isPending
                ? `
              <select
                class="form-select request-vault-select"
                data-request-id="${req.id}"
              >
                <option value="">Select vault</option>
              </select>
            `
                : "-"
            }
          </td>
          <td>
            ${
              isPending
                ? `
              <button
                class="btn btn-sm btn-success payroll-request-approve-btn"
                data-request-id="${req.id}"
              >
                Approve
              </button>
              <button
                class="btn btn-sm btn-outline-danger payroll-request-reject-btn"
                data-request-id="${req.id}"
                disabled
              >
                Reject
              </button>
            `
                : ""
            }
          </td>
        </tr>
      `;
    })
    .join("");

  const tableHtml = `
    ${statsHtml}
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Payroll Requests</h5>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Employee</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Month</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Vault</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml || `<tr><td colspan="9" class="text-center">No requests found</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  container.innerHTML = tableHtml;

  // بعد ما نبني الجدول، نملى اختيارات الخزن لكل سطر Pending
  this.populateRequestVaultSelects();
},


async populateRequestVaultSelects() {
  const selects = document.querySelectorAll(".request-vault-select");
  if (!selects.length) return;

  let cachedVaults = STATE.getCache("vaults");
  if (!cachedVaults) {
    try {
      const resp = await API.getVaults();
      cachedVaults = resp;
    } catch (err) {
      Logger.error("Failed to load vaults for request selects:", err);
      return;
    }
  }

  const vaults = cachedVaults?.data || [];
  selects.forEach((sel) => {
    sel.innerHTML = '<option value="">Select vault</option>';
    vaults.forEach((v) => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = `${v.name} (${v.payment_method}) - ${Number(
        v.balance
      ).toLocaleString()} EGP`;
      sel.appendChild(opt);
    });
  });

  Logger.log(
    "populateRequestVaultSelects filled vaults for",
    selects.length,
    "rows"
  );
},

async renderLoans() {
  Logger.info("Rendering loans section");

  return `
    <div class="section-header">
      <h2>Loans Management</h2>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="btn-group" role="group" aria-label="Loans tabs">
          <button
            class="btn btn-sm btn-outline-primary loans-tab-btn active"
            data-loans-tab="company"
          >
            Company Loans
          </button>
          <button
            class="btn btn-sm btn-outline-primary loans-tab-btn"
            data-loans-tab="employee"
          >
            Employee Loans
          </button>
          <button
            class="btn btn-sm btn-outline-primary loans-tab-btn"
            data-loans-tab="payments"
          >
            Loan Payments
          </button>
        </div>
      </div>
    </div>

    <!-- Stats block -->
    <div id="loansStats" class="stats-wrapper mb-3">
      <div class="card stats-card">
        <div class="card-body">
          <div class="row stats-row text-center">
            <div class="col stats-col">
              <div class="stats-label">Total Loans</div>
              <div class="stats-value">-</div>
            </div>
            <div class="col stats-col">
              <div class="stats-label">Active</div>
              <div class="stats-value">-</div>
            </div>
            <div class="col stats-col">
              <div class="stats-label">Completed</div>
              <div class="stats-value">-</div>
            </div>
            <div class="col stats-col">
              <div class="stats-label">Defaulted</div>
              <div class="stats-value">-</div>
            </div>
            <div class="col stats-col">
              <div class="stats-label">Total Amount</div>
              <div class="stats-value">-</div>
            </div>
            <div class="col stats-col">
              <div class="stats-label">Remaining</div>
              <div class="stats-value">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div id="loansActions" class="mb-3" style="text-align:right;">
      <button id="createCompanyLoanBtn" class="btn btn-secondary">
        <i class="fas fa-plus"></i> New Company Loan
      </button>
      <button
        id="createEmployeeLoanBtn"
        class="btn btn-secondary"
        style="margin-left: 0.5rem;"
      >
        <i class="fas fa-plus"></i> New Employee Loan
      </button>
    </div>

    <!-- Loans list -->
    <div id="loansListContainer">
      <div class="card">
        <div class="card-body text-center" style="padding:2rem;">
          Loading loans...
        </div>
      </div>
    </div>
  `;
},


        async renderVendors() {
          return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Vendors Management</h3>
                        </div>
                        <div class="card-body">
                            <p>This section is under development.</p>
                            <p style="color: var(--text-secondary);">Coming soon: Add and manage vendors.</p>
                        </div>
                    </div>
                `;
        },

        async renderReports() {
          return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Reports & Analytics</h3>
                        </div>
                        <div class="card-body">
                            <p>This section is under development.</p>
                            <p style="color: var(--text-secondary);">Coming soon: Comprehensive reports with charts.</p>
                        </div>
                    </div>
                `;
        },

        async renderSettings() {
          return `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Settings</h3>
                        </div>
                        <div class="card-body">
                            <p>This section is under development.</p>
                            <p style="color: var(--text-secondary);">Coming soon: Configure currency, default vault, and notifications.</p>
                        </div>
                    </div>
                `;
        },

        renderSalesStats(dashboard, currency) {
          const stats = [
            {
              label: "Daily Sales",
              value: dashboard.daily_sales?.total || 0,
              icon: "fa-calendar-day",
              color: "primary",
            },
            {
              label: "Weekly Sales",
              value: dashboard.weekly_sales?.total || 0,
              icon: "fa-calendar-week",
              color: "info",
            },
            {
              label: "Monthly Sales",
              value: dashboard.monthly_sales?.total || 0,
              icon: "fa-calendar-alt",
              color: "success",
            },
          ];

          return stats
            .map(
              (stat) => `
                    <div class="stat-card">
                        <div class="stat-icon stat-${stat.color}">
                            <i class="fas ${stat.icon}"></i>
                        </div>
                        <div class="stat-value">${Utils.formatCurrency(
                          stat.value,
                          currency
                        )}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `
            )
            .join("");
        },

        async calculateExpensesByCategory(categories) {
          try {
            // ✅ Get today's date in YYYY-MM-DD format
            const now = new Date();
            const today = now.toISOString().split("T")[0]; // "2025-11-12"

            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 7);

            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            Logger.log("Date check:", {
              today: today,
              weekAgo: weekAgo.toISOString(),
              monthStart: monthStart.toISOString(),
            });

            // Fetch all expenses once
            const expensesResponse = await API.getExpenses({ per_page: 1000 });
            const allExpenses = expensesResponse.data;

            Logger.log(`Total expenses fetched: ${allExpenses.length}`);

            // ✅ Extract date from different formats
            const getDateStr = (dateStr) => {
              // Format: "2025-11-12 22:19:06" or "2025-11-12T22:19:06"
              return dateStr.substring(0, 10); // Get first 10 chars: "2025-11-12"
            };

            // Filter by date
            const dailyData = allExpenses.filter((exp) => {
              const expDate = getDateStr(exp.created_at);
              const match = expDate === today;
              if (match) Logger.log("Today expense found:", exp);
              return match;
            });

            const weeklyData = allExpenses.filter((exp) => {
              const expDate = new Date(exp.created_at);
              return expDate >= weekAgo;
            });

            const monthlyData = allExpenses.filter((exp) => {
              const expDate = new Date(exp.created_at);
              return expDate >= monthStart;
            });

            Logger.log("Filtered expenses:", {
              daily: dailyData.length,
              weekly: weeklyData.length,
              monthly: monthlyData.length,
            });

            // Debug: Show today's expenses details
            if (dailyData.length > 0) {
              Logger.log(
                "Today expenses details:",
                dailyData.map((e) => ({
                  category: e.category_name,
                  amount: e.amount,
                  date: e.created_at,
                }))
              );
            }

            // Group by category
            const groupByCategory = (expenses) => {
              const grouped = {};
              expenses.forEach((exp) => {
                const catName = exp.category_name || "Uncategorized";
                if (!grouped[catName]) {
                  grouped[catName] = 0;
                }
                grouped[catName] += parseFloat(exp.amount);
              });
              return grouped;
            };

            const result = {
              daily: groupByCategory(dailyData),
              weekly: groupByCategory(weeklyData),
              monthly: groupByCategory(monthlyData),
            };

            Logger.log("Grouped expenses:", result);

            return result;
          } catch (error) {
            Logger.error("Failed to calculate expenses by category:", error);
            return { daily: {}, weekly: {}, monthly: {} };
          }
        },


        async paySalary({ salary_id, vault_id, employee_id, amount }) {
          Logger.log("APP.paySalary called with:", {
            salary_id,
            vault_id,
            employee_id,
            amount,
          });

          if (!salary_id || !vault_id || !employee_id) {
            UI.showToast("Missing salary, vault, or employee information", "error");
            return;
          }

          const confirmMsg = [
            `Are you sure you want to pay this salary?`,
            ``,
            `Amount: ${Number(amount || 0).toLocaleString()} EGP`,
          ].join("\n");

          if (!confirm(confirmMsg)) {
            Logger.log("Salary payment cancelled by user");
            return;
          }

          try {
            UI.showLoading("Processing payroll...");
            const payload = {
              salary_id,
              vault_id,
              employee_id,
            };

            Logger.log("Sending API.paySalary with payload:", payload);
            const resp = await API.paySalary(payload);
            Logger.log("Salary paid successfully:", resp);

            UI.showToast("Salary paid successfully", "success");

            // تحديث الكاش والأقسام المرتبطة
            STATE.clearCache("vaults");
            STATE.clearSectionCache("dashboard");
            STATE.clearSectionCache("payroll");

            await this.loadSection("payroll", true);
          } catch (error) {
            Logger.error("Failed to pay salary:", error);
            UI.showToast("Failed to pay salary: " + error.message, "error");
          } finally {
            UI.hideLoading();
          }
        },


        renderExpensesBreakdown(expensesByCategory, currency) {
          const periods = [
            { key: "daily", label: "Today" },
            { key: "weekly", label: "This Week" },

            { key: "monthly", label: "This Month" },
          ];

          return `
                    <div class="expenses-tabs">
                        ${periods
                          .map(
                            (period, index) => `
                            <button class="tab-btn ${
                              index === 0 ? "active" : ""
                            }" data-tab="${period.key}">
                                ${period.label}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                    <div class="expenses-content">
                        ${periods
                          .map((period, index) => {
                            const data = expensesByCategory[period.key];
                            const total = Object.values(data).reduce(
                              (sum, val) => sum + val,
                              0
                            );

                            return `
                                <div class="tab-content ${
                                  index === 0 ? "active" : ""
                                }" data-content="${period.key}">
                                    ${
                                      Object.keys(data).length === 0
                                        ? '<p class="text-center" style="color: var(--text-secondary); padding: var(--space-8);">No expenses recorded</p>'
                                        : `
                                            <div class="expenses-list">
                                                ${Object.entries(data)
                                                  .sort((a, b) => b[1] - a[1])
                                                  .map(([category, amount]) => {
                                                    const percentage =
                                                      total > 0
                                                        ? (amount / total) * 100
                                                        : 0;
                                                    return `
                                                            <div class="expense-item">
                                                                <div class="expense-info">
                                                                    <span class="expense-category">${category}</span>
                                                                    <span class="expense-amount">${Utils.formatCurrency(
                                                                      amount,
                                                                      currency
                                                                    )}</span>
                                                                </div>
                                                                <div class="expense-bar">
                                                                    <div class="expense-bar-fill" style="width: ${percentage}%"></div>
                                                                </div>
                                                                <div class="expense-percentage">${percentage.toFixed(
                                                                  1
                                                                )}%</div>
                                                            </div>
                                                        `;
                                                  })
                                                  .join("")}
                                            </div>
                                            <div class="expenses-total">
                                                <strong>Total:</strong> ${Utils.formatCurrency(
                                                  total,
                                                  currency
                                                )}
                                            </div>
                                        `
                                    }
                                </div>
                            `;
                          })
                          .join("")}
                    </div>
                `;
        },

        renderCashflowTable(cashflow, currency) {
          if (!cashflow || cashflow.length === 0) {
            return '<p class="text-center" style="color: var(--text-secondary); padding: var(--space-8);">No transactions found</p>';
          }

          return `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Employee</th>
                                    <th>Vault</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cashflow
                                  .map((item) => {
                                    const isRevenue = item.type === "revenue";
                                    const amount = parseFloat(item.amount);

                                    return `
                                        <tr>
                                            <td>
                                                <span class="badge badge-${
                                                  isRevenue
                                                    ? "success"
                                                    : "danger"
                                                }">
                                                    <i class="fas fa-${
                                                      isRevenue
                                                        ? "arrow-up"
                                                        : "arrow-down"
                                                    }"></i>
                                                    ${item.type}
                                                </span>
                                            </td>
                                            <td>
                                                <span style="color: var(--${
                                                  isRevenue
                                                    ? "success"
                                                    : "danger"
                                                }); font-weight: 600;">
                                                    ${
                                                      isRevenue ? "+" : "-"
                                                    }${Utils.formatCurrency(
                                      amount,
                                      currency
                                    )}
                                                </span>
                                            </td>
                                            <td>${item.description || "-"}</td>
                                            <td>${
                                              item.employee_name || "-"
                                            }</td>
                                            <td>${item.vault_name || "-"}</td>
                                            <td>${Utils.formatDate(
                                              item.created_at
                                            )}</td>
                                        </tr>
                                    `;
                                  })
                                  .join("")}
                            </tbody>
                        </table>
                    </div>
                `;
        },

        logout() {
          Auth.logout();
        },
      };

      

      // Show modal for adding/editing expense
APP.showExpenseModal = async function(expenseId = null) {
    const modal = document.getElementById('expenseModal');
    const title = document.getElementById('expenseModalTitle');
    const form = document.getElementById('expenseForm');

    form.reset();

    const currentUserId = STATE.user?.id || '';

    // Load categories
    const categoriesResp = await API.getCategories();
    const categorySelect = document.getElementById('expenseCategory');
    categorySelect.innerHTML = '<option value="">Select category</option>';
    categoriesResp.data.forEach(cat => {
        categorySelect.insertAdjacentHTML('beforeend', `<option value="${cat.id}">${cat.name}</option>`);
    });

    // Load vaults
     const vaultsResponse = await API.getVaults();
    const vaultSelect = document.getElementById('expenseVault');
    vaultSelect.innerHTML = '<option value="">Select vault</option>';
    vaultsResponse.data.forEach(vault => {
        vaultSelect.insertAdjacentHTML('beforeend', `<option value="${vault.id}">${vault.name}</option>`);
    });
    Logger.log('Vaults updated:', vaultsResponse.data);

    const employeeInput = document.getElementById('expenseEmployee');
    employeeInput.value = currentUserId;

    if (expenseId) {
        title.textContent = 'Edit Expense';
        const expenseResp = await API.getExpenses({ id: expenseId });
        const exp = expenseResp.data[0];
        form.amount.value = exp.amount;
        form.category_id.value = exp.category_id || '';
        form.type.value = exp.type;
        form.date.value = exp.date ? exp.date.split('T')[0] : '';
        form.description.value = exp.description || '';
        form.vault_id.value = exp.vault_id || '';
        form.dataset.expenseId = expenseId;
        form.employee_id.value = currentUserId;
    } else {
        title.textContent = 'Add Expense';
        delete form.dataset.expenseId;
        form.date.value = new Date().toISOString().split('T')[0];
        form.employee_id.value = currentUserId;
    }

    modal.classList.remove('hidden');
};



// Hide modal and reset form
APP.hideExpenseModal = function() {
    const modal = document.getElementById('expenseModal');
    const form = document.getElementById('expenseForm');
    form.reset();
    delete form.dataset.expenseId;
    modal.classList.add('hidden');
};

// Event listeners for modal close buttons (only once, e.g. inside APP.setupEventListeners)
document.getElementById('expenseModalClose').addEventListener('click', () => {
    APP.hideExpenseModal();
});
document.getElementById('expenseCancelBtn').addEventListener('click', () => {
    APP.hideExpenseModal();
});

// Helper: تحديث بيانات شاشة الداشبورد والخزائن بدون ريـلود كامل
            APP.syncDashboardData = async function() {
                try {
                    const [dashboardData, vaultsResponse] = await Promise.all([
                        API.getDashboard(),
                        API.getVaults()
                    ]);

                    STATE.setCache('dashboard', dashboardData);
                    STATE.setCache('vaults', vaultsResponse);

                    if (STATE.currentSection === 'dashboard') {
                        // تحديث الخزائن فقط مباشرة
                        const vaultsGrid = document.getElementById('vaultsGrid');
                        if (vaultsGrid) {
                            vaultsGrid.innerHTML = this.renderDashboardVaultsGrid(vaultsResponse.data, dashboardData.data.currency || 'EGP');
                        }
                        
                        // تحديث بيانات أخرى في الداشبورد ان لزم
                        const salesStats = document.getElementById('salesStats');
                        if (salesStats) {
                            salesStats.innerHTML = this.renderSalesStats(dashboardData.data, dashboardData.data.currency || 'EGP');
                        }

                        // أيضاً تحديث قسم المصروفات في الداشبورد لو موجود
                        const expensesSection = document.getElementById('expensesSection');
                        if (expensesSection) {
                            const categoriesResp = await API.getCategories();
                            const expensesByCategory = await this.calculateExpensesByCategory(categoriesResp.data);
                            expensesSection.innerHTML = `
                                <div class="section-header"><h2>Expenses Breakdown</h2></div>
                                <div class="expenses-breakdown progressive-fade-in">
                                    ${this.renderExpensesBreakdown(expensesByCategory, dashboardData.data.currency || 'EGP')}
                                </div>
                            `;
                            this.attachSectionEvents('dashboard');
                        }
                    }
                } catch (error) {
                    Logger.error('Failed to sync dashboard data:', error);
                }
    };  

    


// نموذج المصاريف - يمنع التكرار - ويحدث كل شيء في تسلسل واحد فقط
        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const expenseId = form.dataset.expenseId;
            const data = {
                amount: parseFloat(form.amount.value),
                category_id: form.category_id.value || null,
                type: form.type.value,
                date: form.date.value,
                description: form.description.value,
                vault_id: form.vault_id.value,
                employee_id: STATE.user.id
            };

            UI.showLoading(expenseId ? 'Updating expense...' : 'Adding expense...');
            try {
                if (expenseId) {
                    await API.request(`/expenses/${expenseId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    UI.showToast('Expense updated successfully', 'success');
                } else {
                    await API.request('/expenses', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    UI.showToast('Expense added successfully', 'success');
                }

                await APP.loadExpensesData(true);

                // امسح كاش الداشبورد لإجبار إعادة تحميله لاحقًا
                STATE.clearSectionCache('dashboard');

                // إذا الاقسام مفتوحة مثل الداشبورد حاليًا، يمكنك تحميله بقوة / تحديثه فوراً
                if (STATE.currentSection === 'dashboard') {
                    await APP.loadSection('dashboard', true);
                }

                APP.hideExpenseModal();
            } catch (error) {
                UI.showToast('Operation failed: ' + error.message, 'error');
            } finally {
                UI.hideLoading();
            }
        });

      // ============================================
      // UTILITIES
      // ============================================
      const Utils = {
        formatNumber(number, decimals = 2) {
          return new Intl.NumberFormat("en-US", {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
          }).format(number || 0);
        },

        formatDate(dateString) {
          return new Date(dateString).toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        },

        formatCurrency(amount, currency = "EGP") {
          return `${currency} ${this.formatNumber(amount)}`;
        },
      };

      // ============================================
      // START APP
      // ============================================
      document.addEventListener("DOMContentLoaded", () => {
        APP.init();
      });

      // Global error handler
      window.addEventListener("error", (event) => {
        Logger.error("Global error:", event.error);
      });

      window.addEventListener("unhandledrejection", (event) => {
        Logger.error("Unhandled promise rejection:", event.reason);
      });

      // Expose for debugging (remove in production)
      if (CONFIG.DEBUG_MODE) {
        window.FFA_DEBUG = {
          STATE,
          API,
          Logger,
          CONFIG,
        };
        Logger.info("Debug mode enabled. Access via window.FFA_DEBUG");
      }
    </script>
  </body>
</html>
